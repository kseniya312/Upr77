//Это под нужды нашей фирмы, все что касается заявок, переписано заново
Процедура ПерепроведениеОсновании() далее

Процедура ОбработкаПроведения()
	
	ВыбратьСтроки();  
	ТекНомерСтроки = 0;
	ЕстьОшибки = 0;
	Пока ПолучитьСтроку() = 1  Цикл     
		ТекНомерСтроки = ТекНомерСтроки + 1;
		Если (Номенклатура.Комплект = 1) и (ДатаДок > Дата("04.07.13") )  Тогда
			глНеПроводить(Контекст,"В строке " + ТекНомерСтроки + " комплект """+ Номенклатура+""" , который нужно разнести по позиционно.");	 
			ЕстьОшибки = 1;
		КонецЕсли;	
	КонецЦикла; 
	
	Если ЕстьОшибки = 1 Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		НачатьТранзакцию();	
		ВыбратьСтроки();
		Пока ПолучитьСтроку() = 1 Цикл	//Для возможности списывать не всю заявку за один раз
			Регистр.Заявки.Фирма = Фирма;
			Регистр.Заявки.Номенклатура = Номенклатура;
			Регистр.Заявки.ДоговорПокупателя = Договор;
			Регистр.Заявки.ЗаявкаПокупателя = ТекущийДокумент();
			Регистр.Заявки.КоличествоРасход = Количество;
			Регистр.Заявки.СтоимостьРасход = глПересчет(Сумма,Валюта,ДатаДок,Договор.ВалютаВзаиморасчетов,датаДок);	//Резервируем по валюте договора с покупателем (на дату документа), по ней-же будем списывать
			Регистр.Заявки.ДвижениеПриходВыполнить();
		КонецЦикла;
		
		Если флРезервировать=1 Тогда	//нужно создать запись в регистр РезервыТМЦ2
			ВыбратьСтроки();
			а		= итог("Заказ1")+итог("Заказ2")+итог("Отгрузка1")+итог("Отгрузка2");	//Типа а стоит-ли замарачиваться
			склад1	= Константа.СкладОтделаПродаж1; 	//Пискарёвка
			склад2	= Константа.СкладОтделаПродаж2;	//Полюстровский
			Пока ПолучитьСтроку() = 1 Цикл
				//Придётся добавить возможность деления по складам - в зависимости от вариации
				//ВАРИАНТ 1
				Если ДатаДок > '10.10.16' Тогда
					если (Заказ2+Отгрузка2)>0 Тогда
						Регистр.РезервыТМЦ2.Номенклатура = Номенклатура;
						Регистр.РезервыТМЦ2.Склад		 = Склад;
						Регистр.РезервыТМЦ2.Заявка		 = ТекущийДокумент();
						Регистр.РезервыТМЦ2.Количество	 = (Заказ2+Отгрузка2);
						Регистр.РезервыТМЦ2.ДвижениеПриходВыполнить();	 
					КонецЕсли;
				Иначе	
					если а=0 Тогда
						Регистр.РезервыТМЦ2.Номенклатура = Номенклатура;
						Регистр.РезервыТМЦ2.Склад		 = Склад;
						Регистр.РезервыТМЦ2.Заявка		 = ТекущийДокумент();
						Регистр.РезервыТМЦ2.Количество	 = Количество;
						Регистр.РезервыТМЦ2.ДвижениеПриходВыполнить();
					Иначе
						если (Заказ1+Отгрузка1)>0 Тогда
							Регистр.РезервыТМЦ2.Номенклатура = Номенклатура;
							Регистр.РезервыТМЦ2.Склад		 = склад1;
							Регистр.РезервыТМЦ2.Заявка		 = ТекущийДокумент();
							Регистр.РезервыТМЦ2.Количество	 = (Заказ1+Отгрузка1);
							Регистр.РезервыТМЦ2.ДвижениеПриходВыполнить();
						КонецЕсли;
						если (Заказ2+Отгрузка2)>0 Тогда
							Регистр.РезервыТМЦ2.Номенклатура = Номенклатура;
							Регистр.РезервыТМЦ2.Склад		 = склад2;
							Регистр.РезервыТМЦ2.Заявка		 = ТекущийДокумент();
							Регистр.РезервыТМЦ2.Количество	 = (Заказ2+Отгрузка2);
							Регистр.РезервыТМЦ2.ДвижениеПриходВыполнить();
						КонецЕсли;
					КонецЕсли;	
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		//проведем по регистру заявок на складе*********************************************************************************
		Если ((ЗаявкаОбработана = 1) или (ЗаявкаВзятаВРаботу = 1)) и (ВидОперации = Перечисление.ВидыОперацийЗаявок.НаСклад) Тогда
			ВыбратьСтроки();
			Пока ПолучитьСтроку() = 1 Цикл
				Регистр.ЗаявкиНаСклад.Номенклатура = Номенклатура;
				Регистр.ЗаявкиНаСклад.Заявка 	   = ДокОснование;
				Регистр.ЗаявкиНаСклад.ЗаявкаНаСклад = ТекущийДокумент();
				Если ЗаявкаОбработана = 1 Тогда
					Регистр.ЗаявкиНаСклад.КоличествоОбработано = КоличествоФакт;
				ИначеЕсли ЗаявкаВзятаВРаботу = 1 Тогда	
					Регистр.ЗаявкиНаСклад.КоличествоВОбработке = Количество;
				КонецЕсли;
				Регистр.ЗаявкиНаСклад.ДвижениеПриходВыполнить();
			КонецЦикла;
		КонецЕсли;
		//**********************************************************************************************************************
	Исключение
		Сообщить("Проведение не состоялось...","!");
		ОтменитьТранзакцию();
	КонецПопытки;
	ЗафиксироватьТранзакцию();
	
	ПерепроведениеОсновании();	//Перепровести все документы реализации, 
	
КонецПроцедуры


//Т.к. при изменении исходного кол-ва, также необходимо помнить о подчинённых документах
// например, снять с них признак "резерв"
Процедура ПерепроведениеОсновании()	
		
	
КонецПроцедуры