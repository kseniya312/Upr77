//******************************************************************************
// ОПИСАНИЕ МОДУЛЬНЫХ ПЕРЕМЕННЫХ
//
Перем СписокДействий; // для механизма кнопки "Действия"
Перем НачальнаяДатаДокумента; // для механизма контроля уникальности номеров

// Для контроля необходимости пересчетов
Перем СтараяФирма, СтарыйКонтрагент, СтарыйПоставщик;

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ МОДУЛЯ
//

//*****************************************************************************
// ТекстВалюты(Вал)
//
// Параметры: 
//  Вал - элемент справочника "Валюты"
//
// Возвращаемое значение: 
//  Строка валюты
//
// Описание:
// 	Возвращает название валюты или строку "<нет валюты>"
//
Функция ТекстВалюты(Вал) 
	
	Возврат ?(ПустоеЗначение(Вал)=0,Вал.Наименование,"<нет валюты>");
	
КонецФункции                                                                    

//*****************************************************************************
// ЗаголовокФормы()
//
// Возвращаемое значение: 
//	Строка - Название документа
//
//Описание:
// Формирует название документа и заголовок формы диалога
Функция ЗаголовокФормы() 
                      
	Заголовок = глНазваниеДокументаВЖурнале(Контекст);
	Название  = Заголовок+" №";
	
	Если Выбран() = 1 Тогда  
		Если Проведен() = 1 Тогда
			Заголовок = Заголовок + ". Проведен";
		Иначе
			Заголовок = Заголовок + ". Не проведен";
		КонецЕсли;
	Иначе
		Заголовок = Заголовок + ". Новый";
	КонецЕсли;
	
	Если ФлагСвертки = 1  Тогда
		Заголовок = Заголовок + " (создан при свертке базы)";
	КонецЕсли;

	Форма.Заголовок(Заголовок);               

	Возврат Название;
	
КонецФункции //ЗаголовокФормы                                                   

//******************************************************************************                                        
// ИнформацияОНоменклатуре()
//
// Параметры: 
//  Нет
//
// Возвращаемое значение: 
//  Строка информации о Номенклатуре в документе
//
// Описание:
// 	Формирует строку, включающую название, артикул Номенклатуры, реквизиты партии
//
Функция ИнформацияОНоменклатуре()       
	
	ИнфоТекст="";
	
	Если Номенклатура.Выбран()=0 Тогда
		Возврат(ИнфоТекст);
	КонецЕсли;
	
	ИнфоТекст=ИнфоТекст+СокрЛП(Номенклатура.Наименование);
	
	Если ПустоеЗначение(Номенклатура.Артикул)=0 Тогда
		ИнфоТекст=?(ИнфоТекст="","",ИнфоТекст+",");
		ИнфоТекст=ИнфоТекст+" арт. "+СокрЛП(Номенклатура.Артикул);
	КонецЕсли;
	
	Возврат(ИнфоТекст);
	
КонецФункции //ИнформацияОНоменклатуре()

//*****************************************************************************
// ПоКнопкеОперация()
// 
// Параметры: 
//  Нет
//
// Возвращаемое значение: 
//  Нет
//
// Описание:
// 	Вызывается по кнопке редактирования текущего вида операции в документе
//
Процедура ПоКнопкеОперация()
	
	Перем ВремВидОперации;
	
	СписокОпераций = глСоздатьСписокЗначПеречисления("ВидыОперацийПоВводуОстатков", 
					"ОстаткиЗаказов,ОстаткиЗаявок,ОстаткиЗаказовЗаявок,ОстаткиРезервов");
	Если СписокОпераций.ВыбратьЗначение(ВремВидОперации,,,,1)=1 Тогда
		Если ВидОперации <> ВремВидОперации Тогда
			Ответ = "Да";
			Если ВыбратьСтроки() = 1 Тогда
				Ответ = Вопрос("Строки документа будут удалены!
				               |Продолжить?", "Да+Нет", 60);
			КонецЕсли;                   
			Если Ответ = "Да" Тогда
				УдалитьСтроки();
				ВидОперации=ВремВидОперации;
			КонецЕсли;
		КонецЕсли;                   
	КонецЕсли;                   
	
КонецПроцедуры	//ПоКнопкеОперация()

//******************************************************************************
// ПриИзмененииФирмы()
//
// Параметры: 
//  Нет
//
// Возвращаемое значение: 
//  Нет
//
// Описание: 
//  Вызывается из формулы реквизита диалога "Фирма"
//
Процедура ПриИзмененииФирмы()      
	
	Если СтараяФирма <> Фирма Тогда
		// только если изменили
		глПриИзмененииФирмы(Контекст);
		СтараяФирма = Фирма; 
	КонецЕсли;
	
КонецПроцедуры // ПриИзмененииФирмы()

////////////////////////////////////////////////////////////////////////////////
// ПРЕДОПРЕДЕЛЕННЫЕ ПРОЦЕДУРЫ
//
//******************************************************************************
// Предопределенная процедура.
//
Процедура ВводНового(Скопирован)
	                  
	Если (Скопирован = 1) И (ФлагСвертки = 1) Тогда	//копирование документа
		// нельзя копировать документ, полученный при свертке
		СтатусВозврата(0);
		Предупреждение("Нельзя копировать документ, созданный при сверке!", 60);
		Возврат;
	КонецЕсли;

	глЗаполнитьШапку(Контекст, Скопирован);
	
	Если Скопирован = 1 Тогда
		Возврат;
	КонецЕсли;
	
	ВидОперации = Перечисление.ВидыОперацийПоВводуОстатков.ОстаткиЗаказов;
	ФлагСвертки = 0;
	
КонецПроцедуры  // ВводНового()       

//******************************************************************************
// Предопределенная процедура.
//
Процедура ПриОткрытии()
	                       
	Парам = Форма.Параметр;
	Если ТипЗначенияСтр(Парам)="СписокЗначений" Тогда
		Если ПустоеЗначение(Парам.Получить("Команда"))=1 Тогда
			Сообщить("В форму документа "+Вид()+" передан неверный параметр!","I");
			СтатусВозврата(0);Возврат;
		КонецЕсли;
		
		Если (Парам.Получить("Команда") = "ПечатьНаПринтер")
		или  (Парам.Получить("Команда") = "ПечатьНаЭкран") 
		Тогда
			Предупреждение("Документ не имеет печатной формы!", 60);
			СтатусВозврата(0);Возврат;
		Иначе
			Сообщить("В форму документа "+Вид()+" передана неверная команда "+Парам.Получить("Команда")+"!","I");
			СтатусВозврата(0);Возврат;
		КонецЕсли;
	КонецЕсли;

	// инициализация модульных переменных, контролирующих выполнение
	// пересчетов и обновление надписей в форме
	СтараяФирма   		  	= Фирма;  
	НачальнаяДатаДокумента  = ДатаДок;

	глПроверкаРазрешенияРедактирования(Контекст);
	
	Если ФлагСвертки = 1 Тогда
		// выписан автоматически при свертке
		Форма.ТолькоПросмотр(1);
		
		Если ВидОперации = Перечисление.ВидыОперацийПоВводуОстатков.ОстаткиЗаказов Тогда
			Форма.ЗаявкаПокупателя.Видимость(0);
			Форма.Склад.Видимость(0);
		ИначеЕсли ВидОперации = Перечисление.ВидыОперацийПоВводуОстатков.ОстаткиЗаявок Тогда
			Форма.ЗаказПоставщику.Видимость(0);
			Форма.Склад.Видимость(0);
		ИначеЕсли ВидОперации = Перечисление.ВидыОперацийПоВводуОстатков.ОстаткиЗаказовЗаявок Тогда
			Форма.Стоимость.Видимость(0);
			Форма.Договор.Видимость(0);
			Форма.Склад.Видимость(0);
		ИначеЕсли ВидОперации = Перечисление.ВидыОперацийПоВводуОстатков.ОстаткиРезервов Тогда
			Форма.Стоимость.Видимость(0);
			Форма.ЗаказПоставщику.Видимость(0);
		КонецЕсли;
	КонецЕсли;
	
	// если дата проведенного документа больше ТА, то открываем только на просмотр,
	// так как его все равно не удастся сохранить после редактирования.
	Если (Проведен() = 1) И (ДатаДок > ПолучитьДатуТА()) Тогда
		Форма.ТолькоПросмотр(1);
	КонецЕсли;
	
	//Инициализирум список действий по кнопке "Действия"
	СписокДействий = СоздатьОбъект("СписокЗначений");
	СписокДействий.ДобавитьЗначение("Отчет о движениях документа");
	СписокДействий.ДобавитьЗначение("Отчет о бухгалтерских проводках");
    
	// Если открыли только на просмотр, то надо кнопки сделать недоступными
	Если Форма.ТолькоПросмотр()=1 Тогда
	    // СДЕЛАТЬ НЕДОСТУПНЫМИ КНОПКИ МОДИФИКАЦИИ ДОКУМЕНТА
		Форма.кнОперация.Доступность(0);
		Форма.кнОК.Доступность(0);
		Форма.кнХПроект.Доступность(0);
		Форма.кнЗаписать.Доступность(0);
		Форма.кнПровести.Доступность(0);
	КонецЕсли;
	
	СписокДействий.ДобавитьЗначение("Перейти в журнал");
	
	// кнопка по умолчанию
	Если (Форма.ТолькоПросмотр() = 1) ИЛИ ((ДатаДок < Макс(РабочаяДата(), ПолучитьДатуТА()) ) И (Выбран() = 1)) Тогда
	    Форма.КнопкаПоУмолчанию("кнЗакрыть");
	Иначе
	    Форма.КнопкаПоУмолчанию("кнОК");
	КонецЕсли;
	
	глАктивизироватьРеквизит(Контекст);
		
	Форма.Количество.ВыполнятьФормулуТолькоПриИзменении(1);
	Форма.Стоимость .ВыполнятьФормулуТолькоПриИзменении(1);
	
 	//Если документ еще не проведен, тогда 
	//проведение делаем только в потоке
	Если ( Проведен() = 0 ) Тогда
		ПроводитьПослеТА(1,1);
	КонецЕсли;                                           
		
КонецПроцедуры  // ПриОткрытии()        
                      
//******************************************************************************
// Предопределенная процедура
//
Процедура ПриЗаписи()
	
	Если глМожноЗаписатьДокумент(Контекст)=0 Тогда
		СтатусВозврата(0);                        
	ИначеЕсли глКонтрольДатыДокумента(Контекст, НачальнаяДатаДокумента)=1 Тогда
		СтатусВозврата(0);
	КонецЕсли;
	ПриЗаписиДокумента(Контекст);
КонецПроцедуры // ПриЗаписи()   

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ
// 
 