перем рег1, ЕстьИзменения;
//*******************************************

Процедура ЗаполниТЗ()
	
	ТЗ.УдалитьСтроки();
	ТЗ1=СоздатьОбъект("ТаблицаЗначений");
	Если (ПустоеЗначение(Склад) <> 1)
	и (ПустоеЗначение(Заявка) <> 1)
	и (ПустоеЗначение(Номенклатура) <> 1) Тогда
		//Рег1.УстановитьФильтр(?(ПустоеЗначение(Номенклатура) <> 1,Номенклатура,""),?(ПустоеЗначение(Склад) <> 1,Склад,""),?(ПустоеЗначение(Заявка) <> 1,Заявка,""));
												Рег1.УстановитьФильтр(Номенклатура,Склад,Заявка);
	ИначеЕсли (ПустоеЗначение(Склад) = 1)
	и (ПустоеЗначение(Заявка) <> 1)
	и (ПустоеЗначение(Номенклатура) <> 1) Тогда
												Рег1.УстановитьФильтр(Номенклатура,,Заявка);
	ИначеЕсли (ПустоеЗначение(Склад) = 1)
	и (ПустоеЗначение(Заявка) = 1)
	и (ПустоеЗначение(Номенклатура) <> 1) Тогда
												Рег1.УстановитьФильтр(Номенклатура,,);
	ИначеЕсли (ПустоеЗначение(Склад) = 1)
	и (ПустоеЗначение(Заявка) <> 1)
	и (ПустоеЗначение(Номенклатура) = 1) Тогда
												Рег1.УстановитьФильтр(,,Заявка);
	ИначеЕсли (ПустоеЗначение(Склад) <>  1)
	и (ПустоеЗначение(Заявка) <> 1)
	и (ПустоеЗначение(Номенклатура) = 1) Тогда
												Рег1.УстановитьФильтр(,Склад,Заявка);
	ИначеЕсли (ПустоеЗначение(Склад) <>  1)
	и (ПустоеЗначение(Заявка) = 1)
	и (ПустоеЗначение(Номенклатура) <>  1) Тогда
												Рег1.УстановитьФильтр(Номенклатура,Склад,);
	ИначеЕсли (ПустоеЗначение(Склад) <>  1)
	и (ПустоеЗначение(Заявка) = 1)
	и (ПустоеЗначение(Номенклатура) =  1) Тогда
												Рег1.УстановитьФильтр(,Склад,);	
	КонецЕсли;
	
	
	Рег1.ВыгрузитьИтоги(ТЗ1,1,1);	//В ТЗ мы запомнили все остатки товаров на складе
	
	ТЗ1.Свернуть("Склад,Заявка,Номенклатура","Количество");
	ТЗ1.УстановитьПараметрыКолонки("Количество",,,,,5);
	ТЗ1.УстановитьПараметрыКолонки("Номенклатура",,,,,20);
	ТЗ1.НоваяКолонка("КоличествоНовое","Число",14,3,"Кол-во (новое)",5);
	//ТЗ1.НоваяКолонка("ДнейРезерва","Число",3,0,"Дней",5);
	//ТЗ1.НоваяКолонка("ДнейРезерваНовый","Число",3,0,"Дней (новое)",5);
	ТЗ1.НоваяКолонка("СрокРезерва","число",3,0,"Срок",3);
	ТЗ1.НоваяКолонка("Контрагент","Справочник.Контрагенты",,,,15);
	ТЗ1.НоваяКолонка("Автор","Справочник.Пользователи",,,,15);

	ТЗ1.УстановитьПараметрыКолонки("Склад",,10);
	ТЗ1.УстановитьПараметрыКолонки("Заявка",,25);
	
		
	ТЗ1.ВыбратьСтроки();
	Пока ТЗ1.ПолучитьСтроку()=1 Цикл   
		Если ТЗ1.Заявка.Вид() <> "ЗаявкаПокупателя" Тогда
			Продолжить;
		КонецЕсли;
		
	    ТЗ1.Автор			= ТЗ1.Заявка.Автор; 
		ТЗ1.СрокРезерва		= ТекущаяДата()	- ТЗ1.Заявка.ДатаОтгрузки;  
		ТЗ1.Контрагент		= ТЗ1.Заявка.Контрагент;
		//ТЗ1.ДнейРезерва		= ТЗ1.Заявка.ДатаОтгрузки 	- ТЗ1.Заявка.ДатаДок;
		ТЗ1.КоличествоНовое = ТЗ1.Количество;
		//ТЗ1.ДнейРезерваНовый= ТЗ1.ДнейРезерва;	
	КонецЦикла;
	
	ТЗ1.Выгрузить(ТЗ);
	ТЗ.УдалитьСтроки();
	ТЗ1.ВыбратьСтроки();
	а = Константа.БазовоеЧислоДнейРезерва.Получить(ТекущаяДата());
	Пока ТЗ1.ПолучитьСтроку()=1 Цикл 
		
		Если ТЗ1.Заявка.Вид() <> "ЗаявкаПокупателя" Тогда
			Продолжить;
		КонецЕсли;
		
		Если ПустоеЗначение(Контрагент) <> 1 Тогда
			Если Контрагент <> ТЗ1.Контрагент Тогда
				Продолжить;
			КонецЕсли;	
		КонецЕсли;	
		
		Если флВсеРезервы = 1 Тогда
	    	    ТЗ.НоваяСтрока();
				ТЗ.Склад		= ТЗ1.Склад;
				ТЗ.Контрагент	= ТЗ1.Контрагент;
				ТЗ.СрокРезерва	= ТЗ1.СрокРезерва;
				ТЗ.Автор		= ТЗ1.Автор;
				ТЗ.Заявка		= ТЗ1.Заявка;
				ТЗ.Номенклатура 	= ТЗ1.Номенклатура;
				ТЗ.Количество 		= ТЗ1.Количество;
				ТЗ.КоличествоНовое 	= ТЗ1.КоличествоНовое;
				//ТЗ.ДнейРезерваНовый	= ТЗ1.ДнейРезерваНовый;	
				//ТЗ.ДнейРезерва 		= ТЗ1.ДнейРезерва;
		Иначе
			Если а < число(ТЗ1.СрокРезерва) Тогда	//Всё что просрочено покажем тут
	       		ТЗ.НоваяСтрока();
				ТЗ.Склад		= ТЗ1.Склад;
				ТЗ.Контрагент	= ТЗ1.Контрагент;
				ТЗ.СрокРезерва	= ТЗ1.СрокРезерва;
				ТЗ.Автор		= ТЗ1.Автор;
				ТЗ.Заявка		= ТЗ1.Заявка;
				ТЗ.Номенклатура 	= ТЗ1.Номенклатура;
				ТЗ.Количество 		= ТЗ1.Количество;
				ТЗ.КоличествоНовое 	= ТЗ1.КоличествоНовое;
				//ТЗ.ДнейРезерваНовый	= ТЗ1.ДнейРезерваНовый;	
				//ТЗ.ДнейРезерва 		= ТЗ1.ДнейРезерва;
			КонецЕсли;
		КонецЕсли;	
	КонецЦикла;
	
	ТЗ1.УдалитьСтроки();
	ТЗ.Выгрузить(ТЗ1);
	ТЗ.УдалитьСтроки();
	
	Если НазваниеНабораПрав() = "Продавец" Тогда
		ТЗ1.Сортировать("Автор+");
		ТЗ1.ВыбратьСтроки();
		Пока ТЗ1.ПолучитьСтроку()=1 Цикл
		    Если ТЗ1.Автор = глПользователь Тогда
            	ТЗ.НоваяСтрока();
				ТЗ.Склад			= ТЗ1.Склад;
				ТЗ.Контрагент		= ТЗ1.Контрагент;
				ТЗ.СрокРезерва		= ТЗ1.СрокРезерва;
				ТЗ.Автор			= ТЗ1.Автор;
				ТЗ.Заявка			= ТЗ1.Заявка;
				ТЗ.Номенклатура 	= ТЗ1.Номенклатура;
				ТЗ.Количество 		= ТЗ1.Количество;
				ТЗ.КоличествоНовое 	= ТЗ1.КоличествоНовое;
				//ТЗ.ДнейРезерваНовый	= ТЗ1.ДнейРезерваНовый;	
				//ТЗ.ДнейРезерва 		= ТЗ1.ДнейРезерва;
			КонецЕсли;
		КонецЦикла;
	иначе
		ТЗ1.Сортировать("Автор+");
		ТЗ1.ВыбратьСтроки();
		Пока ТЗ1.ПолучитьСтроку()=1 Цикл
           	ТЗ.НоваяСтрока();
			ТЗ.Склад			= ТЗ1.Склад;
			ТЗ.Контрагент		= ТЗ1.Контрагент;
			ТЗ.СрокРезерва		= ТЗ1.СрокРезерва;
			ТЗ.Автор			= ТЗ1.Автор;
			ТЗ.Заявка			= ТЗ1.Заявка;
			ТЗ.Номенклатура 	= ТЗ1.Номенклатура;
			ТЗ.Количество 		= ТЗ1.Количество;
			ТЗ.КоличествоНовое 	= ТЗ1.КоличествоНовое;
			//ТЗ.ДнейРезерваНовый	= ТЗ1.ДнейРезерваНовый;	
			//ТЗ.ДнейРезерва 		= ТЗ1.ДнейРезерва;
		КонецЦикла;
	КонецЕсли;
	ТЗ1="";
	ТЗ.НоваяКолонка("ПиктограммаКоличество","Число",,," ",3);
	//ТЗ.НоваяКолонка("ПиктограммаДни","Число",,," ",3);
	ТЗ.НоваяКолонка("Пустая","Число",,," ",3);
	//ТЗ.ВыводитьПиктограммы("ПиктограммаДни",1);
	ТЗ.ВыводитьПиктограммы("ПиктограммаКоличество",1);
	//ТЗ.ВидимостьКолонки("ДнейРезерва, ДнейРезерваНовый, ПиктограммаДни",0);
	ТЗ.ВидимостьКолонки("ПиктограммаКоличество",1,1);
	//ТЗ.ВидимостьКолонки("СрокРезерва",1,7);
	ТЗ.Сортировать("СрокРезерва+");
	
КонецПроцедуры	


Процедура ПриОткрытии()

	Если НазваниеНабораПрав()="Сервис" Тогда
		форма.Закрыть(0);
		возврат;
	КонецЕсли;
    
	ЗаполниТЗ();
КонецПроцедуры
                
Процедура ОбработайСтроку()
	ТекущаяСтрока	= ТЗ.ТекущаяСтрока();
	
	Если ТекущаяСтрока = 0 Тогда
	    Возврат;
	КонецЕсли;
	
	ТекущаяКолонка 	= ТЗ.ТекущаяКолонка();
	ИмяКолонки = "";
	ТЗ.ПолучитьПараметрыКолонки(ТекущаяКолонка,,,,ИмяКолонки);
	Если ИмяКолонки = "Заявка" Тогда
		Док	= ТЗ.ПолучитьЗначение(ТекущаяСтрока,"Заявка");
		попытка 
			ОткрытьФорму(Док);
		исключение
			сообщить("Возможно этот документ уже открыт!");
		КонецПопытки;
	ИначеЕсли ИмяКолонки = "Кол-во (новое)" Тогда
		Значение = ТЗ.ПолучитьЗначение(ТекущаяСтрока,ТекущаяКолонка); 
		Если ВвестиЧисло(Значение,ИмяКолонки,,0,0) = 1 Тогда 
			Если Многострочный = 1 Тогда
				Если Вопрос("Установить данное значение для всех строк?", "Да+Нет", 60) = "Да" Тогда 
					ТЗ.ВыбратьСтроки();
					Пока ТЗ.ПолучитьСтроку() = 1 Цикл
						ТЗ.КоличествоНовое = Значение;
						Если Значение < ТЗ.Количество Тогда
							ТЗ.ПиктограммаКоличество = 2;
							ЕстьИзменения = 1;
						ИначеЕсли Значение > ТЗ.Количество Тогда
							ТЗ.ПиктограммаКоличество = 1; 
							ЕстьИзменения = 1;
						КонецЕсли;
					КонецЦикла;	
				Иначе	
					ТЗ.УстановитьЗначение(ТекущаяСтрока,ТекущаяКолонка,Значение);
					Если Значение < ТЗ.ПолучитьЗначение(ТекущаяСтрока,"Количество") Тогда
						ТЗ.УстановитьЗначение(ТекущаяСтрока,"ПиктограммаКоличество",2);
						ЕстьИзменения = 1;
					ИначеЕсли Значение > ТЗ.ПолучитьЗначение(ТекущаяСтрока,"Количество") Тогда
						ТЗ.УстановитьЗначение(ТекущаяСтрока,"ПиктограммаКоличество",1);
						ЕстьИзменения = 1;
					КонецЕсли;
				КонецЕсли;
			Иначе
				ТЗ.УстановитьЗначение(ТекущаяСтрока,ТекущаяКолонка,Значение);
				Если Значение < ТЗ.ПолучитьЗначение(ТекущаяСтрока,"Количество") Тогда
					ТЗ.УстановитьЗначение(ТекущаяСтрока,"ПиктограммаКоличество",2);
					ЕстьИзменения = 1;
				ИначеЕсли Значение > ТЗ.ПолучитьЗначение(ТекущаяСтрока,"Количество") Тогда
					ТЗ.УстановитьЗначение(ТекущаяСтрока,"ПиктограммаКоличество",1);
					ЕстьИзменения = 1;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ИмяКолонки = "Дней (новое)" Тогда
		Значение = ТЗ.ПолучитьЗначение(ТекущаяСтрока,ТекущаяКолонка);
		Если ВвестиЧисло(Значение,ИмяКолонки,,0,0) = 1 Тогда
			ТЗ.УстановитьЗначение(ТекущаяСтрока,ТекущаяКолонка,Значение);
		КонецЕсли;
		Если Значение < ТЗ.ПолучитьЗначение(ТекущаяСтрока,"ДнейРезерва") Тогда
			ТЗ.УстановитьЗначение(ТекущаяСтрока,"ПиктограммаДни",2);
			ЕстьИзменения = 1;
		ИначеЕсли Значение > ТЗ.ПолучитьЗначение(ТекущаяСтрока,"ДнейРезерва") Тогда
			ТЗ.УстановитьЗначение(ТекущаяСтрока,"ПиктограммаДни",1);
			ЕстьИзменения = 1;
		КонецЕсли;
	Иначе
		Возврат;
	КонецЕсли;
КонецПроцедуры  

Процедура ОбрСклад()
	ЗаполниТЗ();
КонецПроцедуры  

Процедура ОбрКонтрагент()
	ЗаполниТЗ();
КонецПроцедуры  

Процедура ОбрЗаявка()
	ЗаполниТЗ();
КонецПроцедуры

Процедура ОбрНоменклатура()
	ЗаполниТЗ();
КонецПроцедуры

//======================================================================
Процедура ПоКнопкеПрименить()
	Если ЕстьИзменения = 1 Тогда
		ДокКорреутировкиРезерва = СоздатьОбъект("Документ.СнятиеРезерва");
		ТекущийСклад = "";
		                   
	
		ТЗ.Сортировать("Склад");
		ТЗ.ВыбратьСтроки();
		Пока ТЗ.ПолучитьСтроку() = 1 Цикл
			Если ТЗ.ПиктограммаКоличество <> 0 Тогда
				Если ТекущийСклад <> ТЗ.Склад Тогда
					Если ДокКорреутировкиРезерва.КоличествоСтрок() <> 0 Тогда
						Попытка
							ДокКорреутировкиРезерва.Записать();
							ДокКорреутировкиРезерва.Провести();
							Сообщить("Сформирован документ корректировки резерва: "+ДокКорреутировкиРезерва.ТекущийДокумент());
						Исключение
							Сообщить("Ошибка формирования документа корректировки резерва: " + ОписаниеОшибки());
						КонецПопытки;
					КонецЕсли;
					ТекущийСклад = ТЗ.Склад;
					ДокКорреутировкиРезерва.Новый();
					глЗаполнитьШапку(ДокКорреутировкиРезерва, 0,"Продажа"); 
					ДокКорреутировкиРезерва.Склад 		= ТекущийСклад;
					ДокКорреутировкиРезерва.ДатаДок 	= ТекущаяДата();
					ДокКорреутировкиРезерва.ВидОперации = "Корректировка резерва";
					ДокКорреутировкиРезерва.Автор 		= глПользователь;
					ДокКорреутировкиРезерва.Комментарий = "Создан автоматически из обработки по управлению резервами.";
				КонецЕсли;
				
				ДокКорреутировкиРезерва.НоваяСтрока();
				ДокКорреутировкиРезерва.Номенклатура = ТЗ.Номенклатура;
				ДокКорреутировкиРезерва.Количество = ТЗ.Количество;
				ДокКорреутировкиРезерва.Заявка = ТЗ.Заявка;
				ДокКорреутировкиРезерва.КоличествоНовое = ТЗ.КоличествоНовое;	
			КонецЕсли;	
		КонецЦикла;
		
		Если ДокКорреутировкиРезерва.КоличествоСтрок() <> 0 Тогда
			Попытка
				ДокКорреутировкиРезерва.Записать();
				ДокКорреутировкиРезерва.Провести();
				Сообщить("Сформирован документ корректировки резерва: "+ДокКорреутировкиРезерва.ТекущийДокумент());
			Исключение
				Сообщить("Ошибка формирования документа корректировки резерва: " + ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
		
		ЕстьИзменения = 0;
		ЗаполниТЗ();
		Сообщить("Изменения приняты!");
	КонецЕсли;
КонецПроцедуры // ПоКнопкеПрименить

//Строки запуска
рег1 = СоздатьОбъект("Регистр.РезервыТМЦ2");
ЕстьИзменения = 0;
