////////////////////////////////////////////////////////////////////////////////
// ѕ≈–≈ћ≈ЌЌџ≈ ћќƒ”Ћя
// 
ѕерем	»м€–еквизита»дентификации;
ѕерем	»ƒ—хемыƒл€ѕроверки;
ѕерем	“екуща€«акладка;
ѕерем	—писок“оваров;
ѕерем	ƒокумент;
ѕерем	—хемыƒл€ѕроверки;
ѕерем	Ёлемент аталога;

ѕерем	“екуща€ атегори€÷ен;

ѕерем	Ёл оммерческа€»нформаци€;

ѕерем	–ежим¬ыбора«начений—войства;


////////////////////////////////////////////////////////////////////////////////
// ѕ–ќ÷≈ƒ”–џ » ‘”Ќ ÷»» ћќƒ”Ћя
// 

//******************************************************************************
// —оздатьѕодчиненныйЁлемент(¬ладелец, »м€“ега, «начение)
//
// ѕараметры:
// 	¬ладелец	-	xml-элемент, у которого создаем подчиненный
//	»м€“ега		-	им€ тега создаваемого элемента
//	«начение	-	значение создаваемого xml-элемента
//
// ¬озвращаемое значение:
// 	—озданный xml-элемент
//
// ќписание
// 	—оздает подчиненный элемент дл€ переданного владельца. ”станавливает значение, если указано.
//
‘ункци€ —оздатьѕодчиненныйЁлемент(¬ладелец, »м€“ега, «начение="")
	
	Ёл¬озврата = ¬ладелец.—оздатьѕодчиненныйЁлемент(»м€“ега, ,»ƒ—хемыƒл€ѕроверки);
	≈сли «начение <> "" “огда
	    Ёл¬озврата.«начение = «начение;
	 онец≈сли;
	
	¬озврат Ёл¬озврата;
	
 онец‘ункции		//	—оздатьѕодчиненныйЁлемент()

//******************************************************************************
// ѕроверить»”становитьјтрибут(Ёл, »дјтрибута, «нјтрибута);
//
// ѕараметры:
// 	Ёл			-	элемент, у которого устанавливаем атрибут
//	»дјтрибута	-	»дентификатор атрибута
//	«нјтрибута	-	значение атрибута
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	≈сли передано не пустое значение, то устанавливаем атрибут xml-элемента
//
ѕроцедура ѕроверить»”становитьјтрибут(Ёл, »дјтрибута, «нјтрибута);
	
	≈сли ѕустое«начение(«нјтрибута) = 0 “огда
		Ёл.”становитьјтрибут(»дјтрибута, «нјтрибута);
	 онец≈сли;
	
 онецѕроцедуры		//	ѕроверить»”становитьјтрибут()

//******************************************************************************
// »д(Ёл, «н)
//
// ѕараметры:
// 	Ёл - xml-элемент
//	«н - значение, преобразуемое к корректному идентификатору
//
// ¬озвращаемое значение:
// 	—трока - корректный идентификатор
//
// ќписание
// 	ѕереданное значение преобразует к корректному идентификатору (замен€ет пробелы, и т.д.)
//
‘ункци€ »д(Ёл, «н)
	
	¬озврат Ёл.ѕреобразовать¬_»ƒ(	—окрЋѕ(«н. од)	);
	
 онец‘ункции		//	»д()

//******************************************************************************
// ќстаток“овара(“ов)
//
// ѕараметры:
// 	“ов - элемент справочника "Ќоменклатура"
//
// ¬озвращаемое значение:
// 	„исло - ќстаток товара на всех складах
//
// ќписание
// 	¬озвращает остаток товара на всех складах
//
‘ункци€ ќстаток“овара(“ов)
	
	¬озврат –егистр.ќстатки“ћ÷.—водныйќстаток( , “ов.“екущийЁлемент(), , ," оличество");
	
 онец‘ункции		//	ќстаток“овара()

//******************************************************************************
// ƒобавить«начени€¬—писокѕо«апросу(—писок, “екст«апроса, »м€јтрибута)
//
// ѕараметры:
// 	—писок			-	—писок«начений
//	“екст«апроса	-	—трока - текст запроса
//	»м€јтрибута		-	»м€ атрибута, значение которго добавл€етс€ в список
//
// ¬озвращаемое значение:
// 	—писок«начений - атрибутов элементов отобранных по произвольному запросу
//
// ќписание
// 	¬ыбирает элементы каталога по запросу и заполн€ет —писок«начений значени€ми указанного атрибута
//
‘ункци€ ƒобавить«начени€¬—писокѕо«апросу(—писок, “екст«апроса, »м€јтрибута)
	
	¬ыборка = Ёлемент аталога.¬ыбрать”злы(“екст«апроса);
	ƒл€ —ч = 0 ѕо ¬ыборка. оличество”злов() - 1 ÷икл
		Ёл			= ¬ыборка.ѕолучить”зел(—ч);
		«нјтрибута	= Ёл.ѕолучитьјтрибут(»м€јтрибута);		
		≈сли —писок.ѕринадлежит(«нјтрибута) = 0 “огда
			—писок.ƒобавить«начение(«нјтрибута);
		 онец≈сли;
	 онец÷икла;
	
	¬озврат —писок;    
	
 онец‘ункции		//	ƒобавить«начени€¬—писокѕо«апросу()
    

//******************************************************************************
// —писокќб€зательных—войств“овара( аталог, »дентификатор¬ аталоге)
//
// ѕараметры:
// 	 аталог					-	каталог товара
//	»дентификатор¬ аталоге	-	идентификатор товара в каталоге
//
// ¬озвращаемое значение:
// 	—писок«начений - —писок об€зательных свойств товара
//
// ќписание
// 	¬озвращает список об€зательных свойств товара
//
‘ункци€ —писокќб€зательных—войств“овара( аталог, »дентификатор¬ аталоге)
	
	—писок = —оздатьќбъект("—писок«начений");
	                                     
	з аталог			= "// аталог[@»дентификатор=""" + —окрЋѕ( аталог.»дентификатор) + """]";
	з“овар				= "/“овар[@»дентификатор¬ аталоге=""" + —окрЋѕ(»дентификатор¬ аталоге) + """]";
	з—сылкаЌа—войство	= "/—сылкаЌа—войство[@ќб€зательно=""1""]";
	                                                                       
	ƒобавить«начени€¬—писокѕо«апросу(—писок, з аталог + з—сылкаЌа—войство, 			"»дентификатор—войства");
	ƒобавить«начени€¬—писокѕо«апросу(—писок, з аталог + з“овар + з—сылкаЌа—войство, "»дентификатор—войства");
                                                                                        
	Ёл“овар 	= Ёлемент аталога.¬ыбрать”зел(з аталог + з“овар);
	
	ѕопытка
		»д–одител€	= Ёл“овар.ѕолучитьјтрибут("–одитель");
	»сключение
		»д–одител€	= "";
	 онецѕопытки;
	
	ѕока ѕустое«начение(»д–одител€) = 0 ÷икл
	    Ёл–одитель	= Ёлемент аталога.¬ыбрать”зел(з аталог + "/√руппа[@»дентификатор=""" + »д–одител€  + """]");
		з√руппа 	= "/√руппа[@»дентификатор=""" + »д–одител€ + """]";
		»д–одител€	= Ёл–одитель.ѕолучитьјтрибут("–одитель");
		
		ƒобавить«начени€¬—писокѕо«апросу(—писок, з аталог + з√руппа + з—сылкаЌа—войство, "»дентификатор—войства");		
	 онец÷икла;
	
    ¬озврат —писок;
	
 онец‘ункции		//	—писокќб€зательных—войств“овара()

//******************************************************************************
// ”становитьјтрибуты аталога(Ёл)
//
// ѕараметры:
// 	Ёл - xml-элемент каталога
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	”станавливает атрибуты элемента " аталог"
//
ѕроцедура ”становитьјтрибуты аталога(Ёл)
	
	ѕроверить»”становитьјтрибут(Ёл, "»дентификатор",	—окрЋѕ(‘орм аталог.»дентификатор));
	ѕроверить»”становитьјтрибут(Ёл, "Ќаименование",		—окрЋѕ(‘орм аталог.Ќаименование));
	ѕроверить»”становитьјтрибут(Ёл, "¬ладелец",			—окрЋѕ(‘орм аталог.¬ладелец аталога.»дентификатор)	);
	ѕроверить»”становитьјтрибут(Ёл, "ќписание", 		—окрЋѕ(‘орм аталог. омментарий));
	ѕроверить»”становитьјтрибут(Ёл, "≈диница", 			—окрЋѕ(‘орм аталог.≈диницаѕо”молчанию.Ќаименование));
	
 онецѕроцедуры		//	”становитьјтрибуты аталога()

//******************************************************************************
// ”становитьјтрибутыѕакетаѕредложений(Ёл)
//
// ѕараметры:
// 	Ёл	-	xml-элемент "ѕакетѕредложений"
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	”станавливает атрибуты элемента "ѕакетѕредложений"
//
ѕроцедура ”становитьјтрибутыѕакетаѕредложений(Ёл)
	
	ѕроверить»”становитьјтрибут(Ёл, "»дентификатор аталога",	—окрЋѕ(‘орм аталог.»дентификатор));
	ѕроверить»”становитьјтрибут(Ёл, "¬ладелец",					—окрЋѕ(‘орм аталог.¬ладелец аталога.»дентификатор)	);
	ѕроверить»”становитьјтрибут(Ёл, "ƒействительно—", 			‘ормƒатаЌач);
	ѕроверить»”становитьјтрибут(Ёл, "ƒействительноƒо", 			‘ормƒата он);
	ѕроверить»”становитьјтрибут(Ёл, "ќписание", 				—окрЋѕ(‘орм омментарий));
	
 онецѕроцедуры		//	”становитьјтрибутыѕакетаѕредложений()

//******************************************************************************
// ”становитьјтрибутыѕредложени€(Ёл, “овар, »д“овара, ќстаток“овара, ÷ена)
//
// ѕараметры:
// 	Ёл				-	xml-элемент "ѕредложение"
//	“овар			-	элемент справочника "Ќоменклатура"
//	»д“овара		-	идентификатор товара
//	ќстаток“овара	-	остаток товара на склад
//	÷ена			-	элемент справочника "÷ены"
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	”станавливает атрибуты элемента "ѕредложение"
//
ѕроцедура ”становитьјтрибутыѕредложени€(Ёл, “овар, »д“овара="", ќстаток“овара=0, ÷ена, ≈диница)

	
	¬алюта	=	“екуща€ атегори€÷ен.¬алюта;
	
	//≈диница	=	÷ена.≈диница.ѕолучить(‘ормƒата он);
	//÷ена	=	÷ена.÷ена.ѕолучить(‘ормƒата он);
	
	
	ѕроверить»”становитьјтрибут(Ёл, "»дентификатор“овара",	»д“овара);
	ѕроверить»”становитьјтрибут(Ёл, " оличество",			ќстаток“овара);
	ѕроверить»”становитьјтрибут(Ёл, "÷ена",					÷ена);
	≈сли ѕустое«начение(≈диница) = 0 “огда
		ѕроверить»”становитьјтрибут(Ёл, "Ќорма”паковки",	≈диница. оэффициент);
		ѕроверить»”становитьјтрибут(Ёл, "≈диница",			—окрЋѕ(≈диница.ќ ≈».Ќаименование));
	 онец≈сли;
	ѕроверить»”становитьјтрибут(Ёл, "¬алюта",				¬алюта.Ќаименование);
	
 онецѕроцедуры		//	”становитьјтрибутыѕредложени€()

//******************************************************************************
// »д“овара¬—обственном аталоге(“овар, »дјтрибута»дентификации)
//
// ѕараметры:
// 	“овар					-	элемент справочника "Ќоменклатура"
//	»дјтрибута»дентификации	-	им€ атрибута идентификации
//
// ¬озвращаемое значение:
// 	«начение идентифицирующего атрибута
//
// ќписание
// 	¬озвращает значение идентифицирующего атрибута
//
‘ункци€ »д“овара¬—обственном аталоге(“овар, »дјтрибута»дентификации)
	                                                                
	≈сли »дјтрибута»дентификации <> "Ўтрих од" “огда
		¬озврат( —окрЋѕ(“овар.ѕолучитьјтрибут(»дјтрибута»дентификации)) );
	»наче
		¬озврат( —окрЋѕ(“овар.ќсновна€≈диница.Ўтрих од) );
	 онец≈сли;

 онец‘ункции		//	»д“овара¬—обственном аталоге()

//******************************************************************************
// ƒобавить—сылкуЌа“овар(Ёл,  аталог, “ов, »м€јтрибута»дентификации)
//
// ѕараметры:
// 	Ёл							-	xml-элемент - владелец
//	 аталог						-	элемент справочника " аталоги"
//	“ов							-	элемент справочника "Ќоменклатура"
//	»м€јтрибута»дентификации	-	им€ атрибута идентификации
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	—оздает элемент "—сылкаЌа“овар" и устанавливает его атрибуты
//
ѕроцедура ƒобавить—сылкуЌа“овар(Ёл,  аталог, “ов, »м€јтрибута»дентификации)
	
	Ёл—сылкаЌа“овар = —оздатьѕодчиненныйЁлемент(Ёл, "—сылкаЌа“овар");
	ѕроверить»”становитьјтрибут(Ёл—сылкаЌа“овар, "»дентификатор аталога",	—окрЋѕ( аталог.»дентификатор));
	ѕроверить»”становитьјтрибут(Ёл—сылкаЌа“овар, "»дентификатор¬ аталоге",	»д“овара¬—обственном аталоге(“ов, »м€јтрибута»дентификации) );
	
 онецѕроцедуры		//	ƒобавить—сылкуЌа“овар()

//******************************************************************************
// ƒобавить—войство( аталог, ¬ид—войства, ƒобавл€ть—сылку)
//
// ѕараметры:
// 	 аталог             элемент справочника " аталоги"
//	¬ид—войства		-	элемент справочника "¬иды—войств"
//	ƒобавл€ть—сылку	-	если 1, то добавл€етс€ также элемент "—сылкаЌа—войство"
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	≈сли свойство еще не добавлено, то добал€ет его в каталог. ”станавливает элемент "—сылкаЌа—войство"
//
ѕроцедура ƒобавить—войство( аталог, ¬ид—войства, ƒобавл€ть—сылку=0)
	
	з аталог	= "// аталог[@»дентификатор=""" + —окрЋѕ( аталог.»дентификатор) + """]";
	”жеƒобавлено = Ёл оммерческа€»нформаци€.¬ыбрать”зел(з аталог + "/—войство[(@»дентификатор=""" + —окрЋѕ(¬ид—войства.»дентификатор¬ аталоге) +""")]/@Ќаименование");
	            
	≈сли ѕустое«начение(”жеƒобавлено) = 0 “огда ¬озврат  онец≈сли;
	
	Ёл аталог	= Ёл оммерческа€»нформаци€.¬ыбрать”зел(з аталог);
	
	Ёл—войство аталога = —оздатьѕодчиненныйЁлемент(Ёл аталог, "—войство");
	
	ѕроверить»”становитьјтрибут(Ёл—войство аталога, "»дентификатор",	—окрЋѕ(¬ид—войства.»дентификатор¬ аталоге));
	ѕроверить»”становитьјтрибут(Ёл—войство аталога, "Ќаименование",		—окрЋѕ(¬ид—войства.Ќаименование));
	ѕроверить»”становитьјтрибут(Ёл—войство аталога, "ћножественность",	¬ид—войства.ћножественность);
                                                                  
	≈сли ƒобавл€ть—сылку = 1 “огда
		Ёл—войство аталога = —оздатьѕодчиненныйЁлемент(Ёл аталог, "—сылкаЌа—войство");
		
		ѕроверить»”становитьјтрибут(Ёл—войство аталога, "»дентификатор аталога",	—окрЋѕ( аталог.»дентификатор));
		ѕроверить»”становитьјтрибут(Ёл—войство аталога, "»дентификатор—войства",	—окрЋѕ(¬ид—войства.»дентификатор¬ аталоге));
		//ѕроверить»”становитьјтрибут(Ёл—войство аталога, "ќб€зательно",				0);
	 онец≈сли;
	
 онецѕроцедуры		//	ƒобавить—войство()

//******************************************************************************
// ƒобавить«начени€—войств(Ёл,  аталог, “ов, —писокќб€зательных—войств)
//
// ѕараметры:
// 	Ёл,  аталог, “ов, —писокќб€зательных—войств
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	ƒобавл€ет значени€ свойств товара
//
ѕроцедура ƒобавить«начени€—войств(Ёл,  аталог, “ов, —писокќб€зательных—войств="")
	
	—писок«аполненных—войств = —оздатьќбъект("—писок«начений");
	
    —пр«н—войств = —оздатьќбъект("—правочник.—войстваЌоменклатуры");
	—пр«н—войств.»спользовать¬ладельца(“ов);
	—пр«н—войств.¬ыбратьЁлементы(1);
	ѕока —пр«н—войств.ѕолучитьЁлемент() = 1 ÷икл
		≈сли —пр«н—войств.ѕометка”далени€() = 1 “огда ѕродолжить  онец≈сли;
		≈сли —пр«н—войств.¬ид—войства. аталог =  аталог “огда
			≈сли ‘л¬ыгружать аталог	= 1 “огда
				ƒобавить—войство( аталог, —пр«н—войств.¬ид—войства);
			 онец≈сли;
			»д—войства			= —окрЋѕ(—пр«н—войств.¬ид—войства.»дентификатор¬ аталоге);
			»д аталога			= —окрЋѕ( аталог.»дентификатор);
			
			Ёл«начение—войства	= —оздатьѕодчиненныйЁлемент(Ёл, "«начение—войства");
			ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор аталога",	»д аталога);
			ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор—войства",	»д—войства);
			ѕроверить»”становитьјтрибут(Ёл«начение—войства, "«начение",					—окрЋѕ(—пр«н—войств.«начение—войства.Ќаименование));
			                                 
			≈сли ‘л¬ыгружать аталог	= 1 “огда
				«апрос = "—сылкаЌа—войство[(@»дентификатор аталога=""%%%"")and(@»дентификатор—войства=""***"")]";
				«апрос = —тр«аменить(«апрос, "%%%", »д аталога);
				«апрос = —тр«аменить(«апрос, "***", »д—войства);
				
				≈сли ѕустое«начение(Ёл.¬ыбрать”зел(«апрос)) = 1 “огда
					Ёл—сылкаЌа—войство	= —оздатьѕодчиненныйЁлемент(Ёл, "—сылкаЌа—войство");
					ѕроверить»”становитьјтрибут(Ёл—сылкаЌа—войство, "»дентификатор аталога",	»д аталога);
					ѕроверить»”становитьјтрибут(Ёл—сылкаЌа—войство, "»дентификатор—войства",	»д—войства);
				 онец≈сли;
			 онец≈сли;
			
			≈сли —писок«аполненных—войств.ѕринадлежит(»д—войства) = 0 “огда
				—писок«аполненных—войств.ƒобавить«начение(»д—войства);
			 онец≈сли;
		 онец≈сли;	
	 онец÷икла;
	
	
	//	ƒополнительную информацию и наименование дл€ печати добавим в виде свойств
	
	 омментарий 		=	—окрЋѕ(“ов. омментарий);
	ѕолнЌаименование	=	—окрЋѕ(“ов.ѕолнЌаименование);
	
	≈сли ѕустое«начение( омментарий) = 0 “огда
		Ёл«начение—войства	= —оздатьѕодчиненныйЁлемент(Ёл, "«начение—войства");
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор аталога",	—окрЋѕ( аталог.»дентификатор));
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор—войства",	" омментарий");
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "«начение",					 омментарий);
	 онец≈сли;
	≈сли ѕустое«начение(ѕолнЌаименование) = 0 “огда
		Ёл«начение—войства	= —оздатьѕодчиненныйЁлемент(Ёл, "«начение—войства");
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор аталога",	—окрЋѕ( аталог.»дентификатор));
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор—войства",	"ѕолноеЌаименование");
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "«начение",					ѕолнЌаименование);
	 онец≈сли;
	
	
	// ѕроверка заполнени€ об€зательных свойств
	
	≈сли “ип«начени€—тр(—писокќб€зательных—войств) = "—писок«начений" “огда
		ƒл€ —ч = 1 ѕо —писокќб€зательных—войств.–азмер—писка() ÷икл
		    »дќб€зательного—войства = —писокќб€зательных—войств.ѕолучить«начение(—ч);
			≈сли —писок«аполненных—войств.ѕринадлежит(»дќб€зательного—войства) = 0 “огда
				з аталог	= "// аталог[@»дентификатор=""" + —окрЋѕ( аталог.»дентификатор) + """]";
				»м€—войства = Ёлемент аталога.¬ыбрать”зел(з аталог + "/—войство[(@»дентификатор=""" + »дќб€зательного—войства +""")]/@Ќаименование").«начение;
				—ообщить("ƒл€ товара """ + “ов + """ не задано значение об€зательного свойства """ + »м€—войства + """");
			 онец≈сли;
		 онец÷икла;					
	 онец≈сли;	
	
 онецѕроцедуры		//	ƒобавить«начени€—войств()
            
//******************************************************************************
// ƒобавить—войства аталога(Ёл,  аталог)
//
// ѕараметры:
// 	Ёл,  аталог
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	ƒобавл€ет виды свойств, используемые дл€ указанного каталога
//
ѕроцедура ƒобавить—войства аталога(Ёл,  аталог)
	
	—пр¬иды—войств = —оздатьќбъект("—правочник.¬иды—войств");
	—пр¬иды—войств.¬ыбратьЁлементыѕо–еквизиту(" аталог",  аталог, 0, 0);
	ѕока —пр¬иды—войств.ѕолучитьЁлемент() = 1 ÷икл		
		Ёл—войство аталога = —оздатьѕодчиненныйЁлемент(Ёл, "—войство");
		
		ѕроверить»”становитьјтрибут(Ёл—войство аталога, "»дентификатор",	—пр¬иды—войств.»дентификатор¬ аталоге );
		ѕроверить»”становитьјтрибут(Ёл—войство аталога, "Ќаименование",		—пр¬иды—войств.Ќаименование );
		ѕроверить»”становитьјтрибут(Ёл—войство аталога, "ћножественность",	—пр¬иды—войств.ћножественность );
	 онец÷икла;	
	
 онецѕроцедуры		//	ƒобавить—войства аталога()

//******************************************************************************
// ”становитьјтрибуты“овара(Ёл, “ов, Ѕез–одител€)
//
// ѕараметры:
// 	Ёл, “ов, Ѕез–одител€
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	”станавливает атрибуты элемента "“овар"
//
ѕроцедура ”становитьјтрибуты“овара(Ёл, “ов, Ѕез–одител€=0)
	
	≈сли “ов.Ёто√руппа() = 1 “огда
		»д¬ аталоге = “ов. од;
	»наче
		»д¬ аталоге = »д“овара¬—обственном аталоге(“ов, »м€–еквизита»дентификации);
	 онец≈сли;
		
	ѕроверить»”становитьјтрибут(Ёл, "»дентификатор",			»д(Ёл, “ов.“екущийЁлемент()));
	ѕроверить»”становитьјтрибут(Ёл, "»дентификатор¬ аталоге",	»д¬ аталоге);
	ѕроверить»”становитьјтрибут(Ёл, "Ќаименование",				“ов.Ќаименование);
	ѕроверить»”становитьјтрибут(Ёл, "–одитель",					?(((ѕустое«начение(“ов.–одитель)=1) »ли (Ѕез–одител€=1)), "", »д(Ёл, “ов.–одитель.“екущийЁлемент())));
	ѕроверить»”становитьјтрибут(Ёл, "≈диница",					—окрЋѕ(“ов.ќсновна€≈диница.ќ ≈».Ќаименование));
	
 онецѕроцедуры		//	”становитьјтрибуты“овара()
    
//******************************************************************************
// ”становитьјтрибуты‘ирмы(Ёл, ‘ирма)
//
// ѕараметры:
// 	Ёл, ‘ирма
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	”станавливает атрибуты элемента " онтрагент"
//
ѕроцедура ”становитьјтрибуты‘ирмы(Ёл, ‘ирма)
	                                  
	≈сли ‘ирма.¬ид() = "‘ирмы" “огда
		ёрЋицо	=	‘ирма.ёрЋицо;
	»наче
		ёрЋицо	=	‘ирма.ёр‘изЋицо;
	 онец≈сли;
	
	‘ирма.»спользоватьƒату(–абоча€ƒата());
	
	»дентификатор				=	—окрЋѕ(‘ирма.»дентификатор);
	Ќаименование				=	—окрЋѕ(ёрЋицо.Ќаименование);
	ќтображаемоеЌаименование	=	?(ѕустое«начение(ёрЋицо.ѕолнЌаименование)=1, Ќаименование, ёрЋицо.ѕолнЌаименование);
    јдрес						=	—окрЋѕ(ёрЋицо.‘актјдрес);
	ёридическийјдрес			=	—окрЋѕ(ёрЋицо.ёрјдрес);
	
	//—айт						=	"";
	// омментарий					=	"";
	
    ѕроверить»”становитьјтрибут(Ёл, "»дентификатор", 			»дентификатор				);
	ѕроверить»”становитьјтрибут(Ёл, "Ќаименование",				Ќаименование				);
	ѕроверить»”становитьјтрибут(Ёл, "ќтображаемоеЌаименование",	ќтображаемоеЌаименование	);
	ѕроверить»”становитьјтрибут(Ёл, "јдрес",					јдрес						);
	ѕроверить»”становитьјтрибут(Ёл, "ёридическийјдрес",			ёридическийјдрес			);	
	
	//ѕроверить»”становитьјтрибут(Ёл, "—айт",						—айт	);
	//ѕроверить»”становитьјтрибут(Ёл, " омментарий",				 омментарий	);
	
 онецѕроцедуры		//	”становитьјтрибуты‘ирмы()

//******************************************************************************
// ƒобавить√руппу(Ёл, √руппа)
//
// ѕараметры:
// 	Ёл, √руппа
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	ƒобавл€ет подчиненный элемент каталога "√руппа"
//
ѕроцедура ƒобавить√руппу(Ёл, √руппа)
	
	»д√руппы	= »д(Ёл, √руппа.“екущийЁлемент());
	”зел 		= Ёл.¬ыбрать”зел("√руппа[(@»дентификатор=""" + —окрЋѕ(»д√руппы) + """)]");
	
	≈сли ѕустое«начение(”зел) = 0 “огда ¬озврат  онец≈сли;
	
	Ёл√руппа = —оздатьѕодчиненныйЁлемент(Ёл, "√руппа");
	    
	Ѕез–одител€ = 0;
	//≈сли —писок“оваров.ѕринадлежит(√руппа.–одитель.“екущийЁлемент()) = 1 “огда
	//	Ѕез–одител€ = 0;
	// онец≈сли;
	”становитьјтрибуты“овара(Ёл√руппа, √руппа, Ѕез–одител€);
	
 онецѕроцедуры		//	ƒобавить√руппу()

//******************************************************************************
// ¬ыгрузка¬ладельца(Ёл орень, ‘ирма)
//
// ѕараметры:
// 	Ёл орень, ‘ирма
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	—оздает и заполн€ет элемент " онтрагент" - владелец каталога
//
ѕроцедура ¬ыгрузка¬ладельца(Ёл орень, ‘ирма)
	
	‘ирма.»спользоватьƒату(–абоча€ƒата());
	
	Ёл‘ирма = —оздатьѕодчиненныйЁлемент(Ёл орень, " онтрагент");
	
	”становитьјтрибуты‘ирмы(Ёл‘ирма, ‘ирма);
	
	Ёл онтакт = —оздатьѕодчиненныйЁлемент(Ёл‘ирма, " онтакт");
	
	Ёл онтакт.”становитьјтрибут("»дентификатор",	Ёл онтакт.ѕреобразовать¬_»ƒ("‘ирма_" + ‘ирма. од) );
	Ёл онтакт.”становитьјтрибут("Ќаименование",		" онтакт фирмы '"+—окрЋѕ(‘ирма.Ќаименование)+"'"); 

	//—оздатьѕодчиненныйЁлемент(Ёл онтакт, " онтактноеЋицо",	—окрЋѕ(‘ирма.–уководитель));
	//—оздатьѕодчиненныйЁлемент(Ёл онтакт, " онтактноеЋицо",	—окрЋѕ(‘ирма. ассир));
	//—оздатьѕодчиненныйЁлемент(Ёл онтакт, " онтактноеЋицо",	—окрЋѕ(‘ирма.√лЅухгалтер));
	—оздатьѕодчиненныйЁлемент(Ёл онтакт, "“елефон",			—окрЋѕ(‘ирма.ёрЋицо.“елефоны));
	—оздатьѕодчиненныйЁлемент(Ёл онтакт, "ѕочта",			—окрЋѕ(‘ирма.Ёлѕочта));
	
 онецѕроцедуры		//	¬ыгрузка¬ладельца()

//******************************************************************************
// –аскрутить–одителейƒо¬ерхнего”ровн€(Ёл–одитель, √руппа)
//
// ѕараметры:
//  Ёл–одитель	-	элемент-родитель - "“овар" или "√руппа"
//	√руппа		-	группа или элемент  справочника "Ќоменклатура", родителей которой добавл€ем
//
// ¬озвращаемое значение:
//  Ќет.
//
// ќписание:
//  ƒобавл€ет родителей товара или группы вплоть ƒокумент самого верхнего уровн€
//
ѕроцедура –аскрутить–одителейƒо¬ерхнего”ровн€(Ёл аталог, √руппа)
	
	≈сли ѕустое«начение(√руппа) = 0 “огда
		ƒобавить√руппу(Ёл аталог, √руппа);
		–аскрутить–одителейƒо¬ерхнего”ровн€(Ёл аталог, √руппа.–одитель);
	 онец≈сли;
	
 онецѕроцедуры		//	–аскрутить–одителейƒо¬ерхнего”ровн€()

//******************************************************************************
// ƒобавитьƒоп—войство“оваров(Ёл аталог, »д—войства, »м€—войства)
//
// ѕараметры:
// 	Ёл аталог, »д—войства, »м€—войства
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	—лужит дл€ добавлени€ произвольных свойств
//
ѕроцедура ƒобавитьƒоп—войство“оваров(Ёл аталог, »д—войства, »м€—войства)
	
	Ёл—войство аталога = —оздатьѕодчиненныйЁлемент(Ёл аталог, "—войство");
	
	ѕроверить»”становитьјтрибут(Ёл—войство аталога, "»дентификатор",	»д—войства );
	ѕроверить»”становитьјтрибут(Ёл—войство аталога, "Ќаименование",		»м€—войства );

 онецѕроцедуры		//	ƒобавитьƒоп—войство“оваров()

//******************************************************************************
// ¬ыгрузка аталога(Ёл орень)
//
// ѕараметры:
// 	Ёл орень - корневой xml-элемент
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	¬ыполн€ет выгрузку товарных позиций каталога
//
ѕроцедура ¬ыгрузка аталога(Ёл орень)	
	    
	—ч			=	0;
	Ёл аталог	=	—оздатьѕодчиненныйЁлемент(Ёл орень, " аталог");
	
	”становитьјтрибуты аталога(Ёл аталог);
          
	//ƒобавить—войства аталога(Ёл аталог, ‘орм аталог);
	
	ƒобавитьƒоп—войство“оваров(Ёл аталог, " омментарий",		"ƒополнительна€ информаци€");
	ƒобавитьƒоп—войство“оваров(Ёл аталог, "ѕолноеЌаименование", "ѕолное наименование");
	
	
	≈сли “ип«начени€—тр(—писок“оваров) = "—писок«начений" “огда
		ƒл€ —ч“оваров = 1 ѕо —писок“оваров.–азмер—писка() ÷икл
			“ов = —писок“оваров.ѕолучить«начение(—ч“оваров);
			
			—ч = —ч + 1;
			≈сли —ч % 100 = 0 “огда
				—осто€ние("¬ыгрузка каталога. ¬ыгружено товаров:  " + —ч);
			 онец≈сли;
			
			≈сли “ов.Ёто√руппа() = 1 “огда
				ƒобавить√руппу(Ёл аталог, “ов);
			»наче
				≈сли ѕустое«начение(»д“овара¬—обственном аталоге(“ов, »м€–еквизита»дентификации)) = 1 “огда ѕродолжить  онец≈сли;
				Ёл = —оздатьѕодчиненныйЁлемент(Ёл аталог, "“овар");
				ƒобавить«начени€—войств(Ёл, ‘орм аталог, “ов);
				”становитьјтрибуты“овара(Ёл, “ов.“екущийЁлемент());
				–аскрутить–одителейƒо¬ерхнего”ровн€(Ёл аталог, “ов.–одитель);
			 онец≈сли;			
		 онец÷икла;
	»наче
		
		—пр“оваров = —оздатьќбъект("—правочник.Ќоменклатура");
		—пр“оваров.¬ыбратьЁлементы();
		ѕока —пр“оваров.ѕолучитьЁлемент() = 1 ÷икл
			
			—ч = —ч + 1;
			≈сли —ч % 100 = 0 “огда
				—осто€ние("¬ыгрузка каталога. ¬ыгружено товаров:  " + —ч);
			 онец≈сли;
			
			≈сли —пр“оваров.Ёто√руппа() = 1 “огда
				Ёл = —оздатьѕодчиненныйЁлемент(Ёл аталог, "√руппа");
			»наче
				≈сли ѕустое«начение(»д“овара¬—обственном аталоге(—пр“оваров, »м€–еквизита»дентификации)) = 1 “огда ѕродолжить  онец≈сли;
				Ёл = —оздатьѕодчиненныйЁлемент(Ёл аталог, "“овар");
				ƒобавить«начени€—войств(Ёл, ‘орм аталог, —пр“оваров);
			 онец≈сли;			
			”становитьјтрибуты“овара(Ёл, —пр“оваров.“екущийЁлемент());
		 онец÷икла;		
	 онец≈сли;
	
 онецѕроцедуры		//	¬ыгрузка аталога()

//******************************************************************************
// —оздатьѕредложение(Ёлѕакет, “ов)
//
// ѕараметры:
// 	Ёлѕакет, “ов
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	—оздает и заполн€ет элемент "ѕредложение"  
//
ѕроцедура —оздатьѕредложение(Ёлѕакет, “ов)

	ќстаток“овара = 0;
	≈сли (‘л“олько»меющиес€ = 1) »ли (‘л¬ыгружать оличество = 1) “огда
		ќстаток“овара = ќстаток“овара(“ов);
		≈сли (ќстаток“овара <= 0) » (‘л“олько»меющиес€ = 1) “огда ¬озврат  онец≈сли;
	 онец≈сли;
	
	»д“овара	=	"";
	÷ена		=	"";
	≈диница÷ены	=	"";
	
	≈сли ‘орм аталог.¬ладелец аталога.¬ид() = "‘ирмы" “огда
		
		//≈сли ѕроверить“овар(“ов) = 0 “огда ¬озврат  онец≈сли;
		                                                  
		≈сли гл¬ернуть÷ену(“ов, “екуща€ атегори€÷ен, ‘ормƒата он, ÷ена, ≈диница÷ены) = 0 “огда
			—ообщить("Ќе задана цена: """ + “екуща€ атегори€÷ен.Ќаименование + """ на товар: " + “ов.Ќаименование);
			¬озврат;
		 онец≈сли;
		
		
		Ёлѕредложение = —оздатьѕодчиненныйЁлемент(Ёлѕакет, "ѕредложение");
		
		≈сли ‘л¬ыгружать аталог = 1 “огда
			»д“овара = »д(Ёлѕредложение, “ов.“екущийЁлемент());
		»наче
			ƒобавить—сылкуЌа“овар(Ёлѕредложение, ‘орм аталог, “ов, »м€–еквизита»дентификации);
		 онец≈сли;
		                                                            
		”становитьјтрибутыѕредложени€(Ёлѕредложение, “ов, »д“овара, ќстаток“овара, ÷ена, ≈диница÷ены);
		    
		≈сли ‘л¬ыгружать аталог	= 0 “огда
			ƒобавить«начени€—войств(Ёлѕредложение, ‘орм аталог, “ов);
		 онец≈сли;
		
	»наче
		
		—прјналогов	= —оздатьќбъект("—правочник.јналоги");
		—прјналогов.»спользовать¬ладельца(“ов);
		
		≈сли —прјналогов.¬ыбратьЁлементыѕо–еквизиту(" аталог", ‘орм аталог, 1, 0) = 1 “огда
			≈сли гл¬ернуть÷ену(“ов, “екуща€ атегори€÷ен, ‘ормƒата он, ÷ена, ≈диница÷ены) = 0 “огда
				—ообщить("Ќе задана цена: """ + “екуща€ атегори€÷ен.Ќаименование + """ на товар: " + “ов.Ќаименование);
				¬озврат;
			 онец≈сли;
		»наче
			¬озврат;
		 онец≈сли;
		
		ѕока —прјналогов.ѕолучитьЁлемент() = 1 ÷икл
			Ёлѕредложение = —оздатьѕодчиненныйЁлемент(Ёлѕакет, "ѕредложение");
			
			ƒобавить—сылкуЌа“овар(Ёлѕредложение, ‘орм аталог, —прјналогов, "»дентификатор¬ аталоге");
			    
			—писокќб€зательных—войств = "";
			≈сли ѕустое«начение(Ёлемент аталога) = 0 “огда
				—писокќб€зательных—войств = —писокќб€зательных—войств“овара(‘орм аталог, —прјналогов.»дентификатор¬ аталоге);
			 онец≈сли;
			                             
			≈сли ‘л¬ыгружать аталог	= 0 “огда
				ƒобавить«начени€—войств(Ёлѕредложение, ‘орм аталог, “ов, —писокќб€зательных—войств);
			 онец≈сли;
			
			”становитьјтрибутыѕредложени€(Ёлѕредложение, “ов, , ќстаток“овара, ÷ена, ≈диница÷ены);
		 онец÷икла;
		
	 онец≈сли;
	
 онецѕроцедуры		//	—оздатьѕредложение()

//******************************************************************************
// ƒобавить«нач—войствѕо”молчанию(Ёл)
//
// ѕараметры:
// 	Ёл - элемент каталога
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	ƒобавл€ет в каталог указанные в диалоге знаени€ свойств по умолчанию
//
ѕроцедура ƒобавить«нач—войствѕо”молчанию(Ёл)
	
    ƒл€ —ч = 1 ѕо ‘орм—пис«начений—войств.–азмер—писка() ÷икл
		
		«н—войства	= ‘орм—пис«начений—войств.ѕолучить«начение(—ч);
        ¬ид—войства	= «н—войства.¬ладелец;
		
		≈сли ‘л¬ыгружать аталог	= 1 “огда
			ƒобавить—войство(‘орм аталог, ¬ид—войства, 1);
		 онец≈сли;
		
		Ёл«начение—войства	= —оздатьѕодчиненныйЁлемент(Ёл, "«начение—войства");
		
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор аталога",	—окрЋѕ(¬ид—войства. аталог.»дентификатор) );
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор—войства",	—окрЋѕ(¬ид—войства.»дентификатор¬ аталоге) );
		ѕроверить»”становитьјтрибут(Ёл«начение—войства, "«начение",					—окрЋѕ(«н—войства.Ќаименование) );
		
	 онец÷икла;
	
 онецѕроцедуры		//	ƒобавить«нач—войствѕо”молчанию()

//******************************************************************************
// ƒобавить—войство_“ип÷ены(Ёл)
//
// ѕараметры:
// 	Ёл - элемент каталога
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	ƒобал€ет предопределенное свойство каталога "“ип÷ены"
//
ѕроцедура ƒобавить—войство_“ип÷ены(Ёл)
	
	¬ид—войства	= —оздатьќбъект("—правочник.¬иды—войств");
	¬ид—войства.Ќовый();
	¬ид—войства.Ќаименование			= "“ип цены";
	¬ид—войства.ћножественность			= 0;
	¬ид—войства.»дентификатор¬ аталоге	= ¬ид—войства. од;
	¬ид—войства. аталог					= ‘орм аталог.“екущийЁлемент();
	
	≈сли ‘л¬ыгружать аталог	= 1 “огда
		ƒобавить—войство(‘орм аталог, ¬ид—войства, 1);
	 онец≈сли;
	
	»д—войства			= —окрЋѕ(¬ид—войства.»дентификатор¬ аталоге);
	Ёл«начение—войства	= —оздатьѕодчиненныйЁлемент(Ёл, "«начение—войства");
	ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор аталога",	—окрЋѕ(‘орм аталог.»дентификатор));
	ѕроверить»”становитьјтрибут(Ёл«начение—войства, "»дентификатор—войства",	»д—войства);
	ѕроверить»”становитьјтрибут(Ёл«начение—войства, "«начение",					—окрЋѕ(“екуща€ атегори€÷ен.Ќаименование));
	
 онецѕроцедуры		//	ƒобавить—войство_“ип÷ены()

//******************************************************************************
// ¬ыгрузкаѕредложений(Ёл орень)
//
// ѕараметры:
// 	Ёл орень - корневой xml-узел
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	¬ыполн€ет выгрузку предложений по установленному текущему типу цен
//
ѕроцедура ¬ыгрузкаѕредложений(Ёл орень)
	              
	—ч		=	0;
	
	Ёлѕакет	=	—оздатьѕодчиненныйЁлемент(Ёл орень, "ѕакетѕредложений");	
	”становитьјтрибутыѕакетаѕредложений(Ёлѕакет);
	                                
	ƒобавить—войство_“ип÷ены(Ёлѕакет);
	ƒобавить«нач—войствѕо”молчанию(Ёлѕакет);
	
	≈сли ѕустое«начение(—писок“оваров) = 0 “огда
		ƒл€ —ч“оваров = 1 ѕо —писок“оваров.–азмер—писка() ÷икл
			“ов = —писок“оваров.ѕолучить«начение(—ч“оваров);
			              
			≈сли ѕустое«начение(»д“овара¬—обственном аталоге(“ов, »м€–еквизита»дентификации)) = 1 “огда
				—ообщить("” товара: `" + “ов + "` не установлен реквизит идентификации: " + »м€–еквизита»дентификации);
				ѕродолжить;
			 онец≈сли;
			
			—ч = —ч + 1;
			≈сли —ч % 100 = 0 “огда
				—осто€ние("¬ыгрузка предложений по цене: " + “екуща€ атегори€÷ен + "  ќбработано товаров:  " + —ч);
			 онец≈сли;
			
			—оздатьѕредложение(Ёлѕакет, “ов);
		 онец÷икла;
	»наче
		—пр“оваров = —оздатьќбъект("—правочник.Ќоменклатура");
		—пр“оваров.¬ыбратьЁлементы();
		ѕока —пр“оваров.ѕолучитьЁлемент() = 1 ÷икл
			≈сли —пр“оваров.Ёто√руппа() = 1 “огда ѕродолжить  онец≈сли;
			
			≈сли ѕустое«начение(»д“овара¬—обственном аталоге(—пр“оваров, »м€–еквизита»дентификации)) = 1 “огда
				—ообщить("” товара: `" + —пр“оваров + "` не установлен реквизит идентификации: " + »м€–еквизита»дентификации);
				ѕродолжить;
			 онец≈сли;
			
			—ч = —ч + 1;
			≈сли —ч % 100 = 0 “огда
				—осто€ние("¬ыгрузка предложений по цене: " + “екуща€ атегори€÷ен + "  ќбработано товаров:  " + —ч);
			 онец≈сли;
			
			—оздатьѕредложение(Ёлѕакет, —пр“оваров);
		 онец÷икла;		
	 онец≈сли;    
	
 онецѕроцедуры		//	¬ыгрузкаѕредложений()

//******************************************************************************
// ¬ыбрать«начени€(—пособ, –еж)
//
// ѕараметры:
// 	—пособ, –еж
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ¬ызываетс€ из формул элементов диалога:
//	—м. кнопки подбора значений свойсвт по умолчанию
//
// ќписание
// 	ќткрывает подбор значений видов свойств
//
ѕроцедура ¬ыбрать«начени€(—пособ, –еж)
	
	–ежим¬ыбора«начений—войства = –еж;
	
	“ек = "";
	≈сли ‘орм—пис«начений—войств.“екуща€—трока() > 0 “огда
		“ек = ‘орм—пис«начений—войств.ѕолучить«начение(‘орм—пис«начений—войств.“екуща€—трока()).¬ладелец;
	 онец≈сли;
	
	‘рм	= ‘орм аталог;
	ќткрытьѕодбор("—правочник.¬иды—войств", "ƒл€ѕодбора", ‘рм, 1, “ек);
	
 онецѕроцедуры		//	¬ыбрать«начени€()

//******************************************************************************
// ”далить«начение(—пис, –еж)
//
// ѕараметры:
// 	—пис, –еж
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ¬ызываетс€ из формул элементов диалога:
//	—м. кнопки подбора значений свойсвт по умолчанию
//
// ќписание
// 	”дал€ет текущую строку из списка значений видов свойств по умолчанию
//
ѕроцедура ”далить«начение(—пис, –еж="")
	
	≈сли –еж = "¬се" “огда
		—пис.”далить¬се();
	»наче
		ѕоз	= —пис.“екуща€—трока();	
		≈сли ѕоз = 0 “огда ¬озврат  онец≈сли;
		
		”дѕоз = —пис.“екуща€—трока();
		—пис.”далить«начение(ѕоз);
		≈сли —пис.–азмер—писка() < ”дѕоз “огда 
			—пис.“екуща€—трока(”дѕоз - 1);
		»наче 
			—пис.“екуща€—трока(”дѕоз);
		 онец≈сли;
	 онец≈сли;
	
 онецѕроцедуры		//	”далить«начение()

//******************************************************************************
// —формировать()
//
// ѕараметры:
// 	Ќет
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	Ѕазова€ процедура - последовательно вызывает процедуры выгрузки каталога, пакетов предложений и т.д.
//
ѕроцедура —формировать()
	                  
	≈сли ‘лќтправить = 0 “огда	// ¬ыгружаем в файл
		
		≈сли ѕуста€—трока(‘орм»м€‘айла)>0 “огда
			ѕредупреждение("Ќе задано им€ файла!");
		    ¬озврат;
		 онец≈сли;	
		    
		ѕопытка
			≈сли ‘—.—уществует‘айл(—окрЋѕ(‘орм»м€‘айла)) > 0 “огда
				≈сли ¬опрос("‘айл '"+—окрЋѕ(‘орм»м€‘айла)+"' существует. ѕереписать?","ƒа+Ќет", 60)="Ќет" “огда
					¬озврат;
				 онец≈сли;	
			 онец≈сли;	
		»сключение
			ѕредупреждение("Ќеверное им€ файла!");
			¬озврат;
		 онецѕопытки;	
		    
		»м€‘айла¬ыгрузки	=	—окрЋѕ(‘орм»м€‘айла);
		
	»наче						// ¬ыгружаем во временный файл и отправл€ем...
		
		≈сли ‘орм—айт.¬ыбран() = 0 “огда
			ѕредупреждение("Ќе задан сайт!");
			¬озврат;
		 онец≈сли;
		
		≈сли ѕуста€—трока(‘орм»м€‘айла) = 0 “огда
			»м€‘айла¬ыгрузки	=	—окрЋѕ(‘орм»м€‘айла);
		»наче
			»м€‘айла¬ыгрузки	=	 аталог»Ѕ() + "Price.xml";
		 онец≈сли;
		
	 онец≈сли;
	
	
	≈сли ‘орм аталог.¬ыбран()=0 “огда
		ѕредупреждение("Ќе выбран каталог товаров!");
		¬озврат;
	 онец≈сли;
	

	≈сли ѕустое«начение( ‘орм аталог.¬ладелец аталога.»дентификатор ) = 1 “огда
		ѕредупреждение("Ќе указан идентификатор владельца каталога!");
		¬озврат;
	 онец≈сли;	
    
	
	‘л“ип÷ен«адан = 0;
	ƒл€ —ч = 1 ѕо ‘орм—пис атегорий÷ен.–азмер—писка() ÷икл
	    ≈сли ‘орм—пис атегорий÷ен.ѕометка(—ч) = 1 “огда
			‘л“ип÷ен«адан = 1;
			ѕрервать;
		 онец≈сли;
	 онец÷икла;
	≈сли ‘л“ип÷ен«адан = 0 “огда
		ѕредупреждение("Ќе отмечена ни одна из категорий цен!");
		¬озврат;
	 онец≈сли;
	           
	
	≈сли «агрузить¬нешнюю омпоненту("V7Plus.dll") <> 1 “огда
        —ообщить("ќшибка загрузки компоненты V7+");
		¬озврат ;
	 онец≈сли;
	
	
	≈сли ѕустое«начение(‘орм аталог.—пособ»дентификацииЌоменклатуры) = 1 “огда
		»м€–еквизита»дентификации	=	" од";
	»наче
		»м€–еквизита»дентификации	=	‘орм аталог.—пособ»дентификацииЌоменклатуры.»дентификатор();
	 онец≈сли;
	
	
	јнализатор	= —оздатьќбъект("AddIn.XMLParser");
	ƒокумент	= јнализатор.—оздатьƒокумент();
	
	
	≈сли ѕустое«начение(ƒокумент) = 1 “огда
		—татус¬озврата(0);
		¬озврат;
	 онец≈сли;
	
	
	ƒокумент.«агрузить»з—троки("<?xml version =""1.0""?><BizTalk xmlns = ""urn:schemas-biztalk-org:biztalk/biztalk-0.81.xml""><Route><From locationID = """" locationType = """" process = """" path = """" handle = """"/><To locationID = """" locationType = """" process = """" path = """" handle = """"/></Route><Body/></BizTalk>");
	
	
	ѕопытка     
		—хемыƒл€ѕроверки = јнализатор.—оздать оллекцию—хем();
		//—хемыƒл€ѕроверки.ƒобавить—хему("urn:schemas-biztalk-org:biztalk/biztalk-0.81.xml", аталог»Ѕ()+"ExtForms\EmptyBizTalkSchema.xdr");
		—хемыƒл€ѕроверки.ƒобавить—хему(»ƒ—хемыƒл€ѕроверки,  аталог»Ѕ() + "ExtForms\CommerML.biz");
		ƒокумент.—хемы = —хемыƒл€ѕроверки;		
	»сключение   
		ѕредупреждение("Ќеправильна€ схема XML-файла: " + ќписаниеќшибки());
		¬озврат;
	 онецѕопытки;
	
        
	Ёлемент аталога = ѕолучитьѕустое«начение();
	
	≈сли (‘орм аталог.¬ладелец аталога.¬ид() = " онтрагенты") » (ѕустое«начение(‘орм аталог.XML‘айл) = 0) “огда
		≈сли ‘с.—уществует‘айл(‘орм аталог.XML‘айл) = 1 “огда
			Ёлемент аталога		= јнализатор.—оздатьƒокумент();
			Ёлемент аталога.—хемы	= —хемыƒл€ѕроверки;
			Ёлемент аталога.«агрузить(‘орм аталог.XML‘айл);
		 онец≈сли;
	 онец≈сли;	
	
	
	
	Ёл оммерческа€»нформаци€ = —оздатьѕодчиненныйЁлемент(ƒокумент.Ёлементƒокумента.¬ыбрать”зел("Body"), " оммерческа€»нформаци€");
	
	
	≈сли ‘л¬ыгружать¬ладельца = 1	“огда
		¬ыгрузка¬ладельца(Ёл оммерческа€»нформаци€, ‘орм аталог.¬ладелец аталога);
	//»наче
	//	¬ыгрузка¬ладельца(Ёл оммерческа€»нформаци€,  онстанта.ќсновна€‘ирма);
	 онец≈сли;
	        
	
	≈сли ‘л¬ыгружать аталог	= 1		“огда ¬ыгрузка аталога(Ёл оммерческа€»нформаци€)	 онец≈сли;
	
	                   
	ƒл€ —ч = 1 ѕо ‘орм—пис атегорий÷ен.–азмер—писка() ÷икл
	    ≈сли ‘орм—пис атегорий÷ен.ѕометка(—ч) = 0 “огда ѕродолжить  онец≈сли;
		“екуща€ атегори€÷ен	= ‘орм—пис атегорий÷ен.ѕолучить«начение(—ч);
		¬ыгрузкаѕредложений(Ёл оммерческа€»нформаци€);
	 онец÷икла;
	
	
	ѕопытка
		//ƒокумент.ѕроверить();	    
	»сключение
		ѕредупреждение(ќписаниеќшибки());
		¬озврат;
	 онецѕопытки;		
	
	
	ѕопытка     
		ƒокумент.«аписать(—окрЋѕ(»м€‘айла¬ыгрузки));
	»сключение   
		ѕредупреждение("Ќе удалось записать файл " + —окрЋѕ(‘орм»м€‘айла) + ": " + ќписаниеќшибки());
		¬озврат;
	 онецѕопытки;	                                                                      
	
	
	≈сли ‘лќтправить = 1 “огда
		—писѕараметров = —оздатьќбъект("—писок«начений");
		—писѕараметров.ƒобавить«начение(‘орм—айт.“екущийЁлемент(),	"—айт");
		—писѕараметров.ƒобавить«начение(—окрЋѕ(»м€‘айла¬ыгрузки),		"ѕолное»м€‘айла");
		
		ќткрыть‘ормућодально("ќбработка.XMLќтправка‘айлаѕоHTTP", —писѕараметров);
		
		≈сли —окрЋѕ(»м€‘айла¬ыгрузки) <> —окрЋѕ(‘орм»м€‘айла) “огда
			≈сли ‘—.—уществует‘айл(—окрЋѕ(»м€‘айла¬ыгрузки)) > 0 “огда
				‘—.”далить‘айл(—окрЋѕ(»м€‘айла¬ыгрузки));
			 онец≈сли;
		 онец≈сли;
	»наче
		ѕредупреждение("¬ыгрузка завершена!");
	 онец≈сли;
	                                      
 онецѕроцедуры		//	—формировать()

//******************************************************************************
// ¬ыбор‘айла()
//
// ѕараметры:
// 	Ќет
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ¬ызываетс€ из формул элементов диалога:
//	 нопка выбора файла выгрузки
//
// ќписание
// 	выбор файла в диалоге
//
ѕроцедура ¬ыбор‘айла()
	
	 аталог = "";
	≈сли ‘—.¬ыбрать‘айл(0, ‘орм»м€‘айла,  аталог, "¬ыберите файл", "*.xml|*.xml", ".xml", ) = 1 “огда
	    ‘орм»м€‘айла =  аталог+‘орм»м€‘айла;
	 онец≈сли;
	
 онецѕроцедуры		//	¬ыбор‘айла()

//******************************************************************************
// ќткрыть‘айл()
//
// ѕараметры:
// 	Ќет
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ќписание
// 	ќткрывает файл дл€ просмотра
//
ѕроцедура ќткрыть‘айл()
	
	≈сли ‘—.—уществует‘айл(‘орм»м€‘айла)=1 “огда
		«апуститьѕриложение(‘орм»м€‘айла);
	»наче
		ѕредупреждение("”казанный файл не существует!", 5);
	 онец≈сли;
	
 онецѕроцедуры		//	ќткрыть‘айл()

//******************************************************************************
// ѕри¬ыборе аталога(ќчистить—писок)
//
// ѕараметры:
// 	Ќет
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ¬ызываетс€ из формул элементов диалога:
//	ѕедаль выбора каталога. –еквизит диалога "‘орм аталог"
//
// ќписание
// 	”станавливает видимость элементов, в зависиости от выбранного каталога
//
ѕроцедура ѕри¬ыборе аталога(ќчистить—писок=0)
	
	≈сли ‘орм аталог.¬ыбран() = 1 “огда
		≈сли ‘орм аталог.¬ладелец аталога.¬ид() = "‘ирмы" “огда
			‘орма.‘л¬ыгружать аталог.¬идимость(1);
			‘орма.‘л¬ыгружать¬ладельца.¬идимость(1);
		»наче
			‘л¬ыгружать аталог		= 0;
			‘л¬ыгружать¬ладельца	= 0;			
			‘орма.‘л¬ыгружать аталог.¬идимость(0);
			‘орма.‘л¬ыгружать¬ладельца.¬идимость(0);
		 онец≈сли;
	»наче
		‘л¬ыгружать аталог		= 0;
		‘л¬ыгружать¬ладельца	= 0;			
		‘орма.‘л¬ыгружать аталог.¬идимость(0);
		‘орма.‘л¬ыгружать¬ладельца.¬идимость(0);		
	 онец≈сли;
	
	≈сли ќчистить—писок = 1 “огда
		‘орм—пис«начений—войств.”далить¬се();
	 онец≈сли;
	
 онецѕроцедуры		//	ѕри¬ыборе аталога()

//******************************************************************************
// ќтобрать“овары()
//
// ѕараметры:
// 	Ќет
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ¬ызываетс€ из формул элементов диалога:
//	 нопка "ѕодбор номенклатуры"
//
// ќписание
// 	¬ызов универсальной обработкуи подбора объектов
//
ѕроцедура ќтобрать“овары()
	
	≈сли “ип«начени€—тр(—писок“оваров) <> "—писок«начений" “огда
		—писок“оваров	= —оздатьќбъект("—писок«начений");
	 онец≈сли;
	
	—писокѕараметров¬ызова = —оздатьќбъект("—писок«начений");
	—писокѕараметров¬ызова.ƒобавить«начение("—правочник",									"“ип");
	—писокѕараметров¬ызова.ƒобавить«начение("Ќоменклатура",									"¬ид");
	—писокѕараметров¬ызова.ƒобавить«начение(—писок“оваров,									"ќбъекты");
	                  
	ѕуть	=	"";
	»м€		=	"";
	–асположение‘айла(ѕуть, »м€);
	≈сли ѕустое«начение(ѕуть + »м€) = 0 “огда
		»м€¬ызвавшей‘ормы = ѕуть + »м€;
	»наче
		»м€¬ызвавшей‘ормы = "ќбработка.XML¬ыгрузка оммерческихѕредложений";
	 онец≈сли;
	—писокѕараметров¬ызова.ƒобавить«начение(»м€¬ызвавшей‘ормы,	"»м€¬ызвавшей‘ормы");

	ќткрыть‘орму("ќбработка.ѕодборќбъектов#", —писокѕараметров¬ызова);
	
 онецѕроцедуры		//	ќтобрать“овары()

//******************************************************************************
// ѕри¬ыборе‘лќтправить()
//
// ѕараметры:
// 	Ќет
//
// ¬озвращаемое значение:
// 	Ќет.
//
// ¬ызываетс€ из формул элементов диалога:
//	‘лажок - "ќтправить на сайт"
//
// ќписание
// 	”правл€ет доступностью элемента диалога  "‘орм—айт" - выбор веб-сайта
//
ѕроцедура ѕри¬ыборе‘лќтправить()
	
    ≈сли ‘лќтправить = 1 “огда
    	‘орма.‘орм—айт.ƒоступность(1);
    »наче
    	‘орма.‘орм—айт.ƒоступность(0);
	 онец≈сли;
	
 онецѕроцедуры		//	ѕри¬ыборе‘лќтправить()
          


////////////////////////////////////////////////////////////////////////////////
// ѕ–≈ƒќѕ–≈ƒ≈Ћ≈ЌЌџ≈ ѕ–ќ÷≈ƒ”–џ
// 
//******************************************************************************
// ѕредопределенна€ процедура.
//
ѕроцедура ѕриќткрытии()
	
	‘орма.«акладки.”далить¬се();
	‘орма.«акладки.ƒобавить«начение("ќсновна€",			"ќсновна€");
	‘орма.«акладки.ƒобавить«начение("ƒополнительна€",	"ƒополнительна€");
	
	‘орма.»спользовать—лой("ќсновной,  нопки", 2);
	“екуща€«акладка = "ќсновна€";
	
	
	≈сли ‘орма.ѕараметр = "TorgCenter" “огда
		—айты = —оздатьќбъект("—правочник.—айты");
		—айты.¬ыбратьЁлементы();
		ѕока —айты.ѕолучитьЁлемент() = 1 ÷икл
			≈сли Ќайти(Ќ–ег(—айты.јдрес—айта), "torgcenter.ru") > 0 “огда
				‘орм—айт	=	—айты.“екущийЁлемент();
				‘лќтправить	=	1;
				ѕрервать;
			 онец≈сли;
		 онец÷икла;
	 онец≈сли;
	
	
	ѕри¬ыборе аталога();
	ѕри¬ыборе‘лќтправить();
	    
 онецѕроцедуры		//	ѕриќткрытии()

//******************************************************************************
// ѕредопределенна€ процедура.
//
ѕроцедура ѕри¬ыборе«акладки(Ќом, «начен)
	
	≈сли «начен = "ќсновна€" “огда
		“екуща€«акладка = "ќсновна€";
		‘орма.»спользовать—лой("ќсновной,  нопки", 2);
		ѕри¬ыборе аталога();
	»наче≈сли «начен = "ƒополнительна€" “огда
		“екуща€«акладка = "ƒополнительна€";
		‘орма.»спользовать—лой("ƒополнительный,  нопки", 2);
	 онец≈сли;
	
 онецѕроцедуры		//	ѕри¬ыборе«акладки()

//******************************************************************************
// ѕредопределенна€ процедура.
//
ѕроцедура ќбработкаѕодбора(«н,  онт‘ормы)
	
	ѕерем ‘рм;      
	
	≈сли «н.¬ид() = "¬иды—войств" “огда
		ќткрытьѕодбор("—правочник.«начени€—войств", ,‘рм, –ежим¬ыбора«начений—войства);
		
		ѕопытка ‘рм.»спользовать¬ладельца(«н)	»сключение  онецѕопытки;
		ѕопытка ‘рм.¬ыбор√руппы(0)				»сключение  онецѕопытки;
			
         онт‘ормы.‘орма.«акрыть();
	»наче
	    ≈сли ‘орм—пис«начений—войств.ѕринадлежит(«н) = 0 “огда
	    	‘орм—пис«начений—войств.ƒобавить«начение(«н, «н.Ќаименование + " (" + «н.¬ладелец.Ќаименование + ")");
	    »наче
	    	ѕредупреждение("Ёто значение уже выбрано!");
	     онец≈сли;
	 онец≈сли;

 онецѕроцедуры		//	ќбработкаѕодбора()

//******************************************************************************
// ѕредопределенна€ процедура.
//
ѕроцедура ѕриѕовторномќткрытии()
	
	≈сли “ип«начени€—тр(—писок“оваров) = "—писок«начений" “огда
		≈сли —писок“оваров.–азмер—писка() = 0 “огда
			—писок“оваров = "";
		 онец≈сли;
	 онец≈сли;
	
 онецѕроцедуры		//	ѕриѕовторномќткрытии()


////////////////////////////////////////////////////////////////////////////////
// ќѕ≈–ј“ќ–џ ќ—Ќќ¬Ќќ… ѕ–ќ√–јћћџ
//
‘орм—пис атегорий÷ен.”далить¬се();
—пр атегорий÷ен = —оздатьќбъект("—правочник.“ипы÷ен");
—пр атегорий÷ен.¬ыбратьЁлементы();
ѕока —пр атегорий÷ен.ѕолучитьЁлемент() = 1 ÷икл
	≈сли —пр атегорий÷ен.ѕометка”далени€() = 1 “огда ѕродолжить  онец≈сли;
	‘орм—пис атегорий÷ен.ƒобавить«начение(—пр атегорий÷ен.“екущийЁлемент());
 онец÷икла;

‘орма.»спользовать«акладки(1);

‘л¬ыгружать аталог		= 0;
‘л¬ыгружать¬ладельца	= 0;
‘л¬ыгружать оличество	= 0;
‘л“олько»меющиес€		= 0;
‘лќтправить				= 0;

‘орма.‘орм—айт.ƒоступность(0);
‘орма.‘л¬ыгружать аталог.¬идимость(0);
‘орма.‘л¬ыгружать¬ладельца.¬идимость(0);

»ƒ—хемыƒл€ѕроверки = "urn:CommerceML";

‘ормƒатаЌач = –абоча€ƒата();
‘ормƒата он = –абоча€ƒата();

‘орм аталог.¬ыбор√руппы(0);

//******************************************************************************




