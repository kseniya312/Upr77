////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ
//
Перем СписокДействий;  // Список действий по документу

 
Процедура ПоКнПолучитьEDI()
	ОткрытьФорму("Обработка.ПолучениеОтправкаEDI#","Получить");	
КонецПроцедуры	

Функция Зарезервировано(__Док)
	Если __Док.Вид() = "ЗаявкаПокупателя" Тогда
		Если __Док.флРезервировать = 1  Тогда
			Возврат "+";
		иначе 
			Возврат " ";
		КонецЕсли;
	КонецЕсли;
КонецФункции	

Функция СуммаРеализации()
	Если ТекущийДокумент.Вид() = "Реализация"  Тогда
		Возврат Формат(?( ТекущийДокумент.ВыданоСоСкидкой=1 , Сумма - СуммаСкидки , Сумма),"N12.2");
	иначе 
		Возврат Формат(Сумма,"N12.2");;
	КонецЕсли;	
КонецФункции	

Функция ПолучиОбъект()   //Для заявок от сервиса, показывать объект
	Если ТекущийДокумент.Вид() = "ЗаявкаПокупателя"  Тогда
		Возврат ТекущийДокумент.Объект;
	иначеесли ТекущийДокумент.Вид() = "Реализация"  Тогда
		Возврат ТекущийДокумент.Объект;
	иначеесли ТекущийДокумент.Вид() = "РКО"  Тогда
		Возврат ТекущийДокумент.Объект;
	иначеесли ТекущийДокумент.Вид() = "ПКО"  Тогда
		Возврат ТекущийДокумент.Объект;
	Иначе
		Возврат "";
	КонецЕсли;	
КонецФункции	

Функция ПолучитьПиктограмму(Режим)
	Если Режим = 1  Тогда
		Выплатили = 0;
		Док= СоздатьОбъект("Документ"); 
		Если ПустоеЗначение(ТекущийДокумент) = 0 Тогда
			Если ТекущийДокумент.Вид() = "Реализация" Тогда
				Если ТекущийДокумент.ВыданоСоСкидкой = 1 Тогда
					Выплатили = 2;
				иначе 
					Выплатили = 1;
				КонецЕсли;
			КонецЕсли; 
		КонецЕсли;
		
		Если ( ТекущийДокумент.Вид() = "ЗаявкаПокупателя" )  Тогда
			Если ( ТекущийДокумент.ВидОперации = Перечисление.ВидыОперацийЗаявок.НаСклад ) ИЛИ 
			( ТекущийДокумент.ВидОперации = Перечисление.ВидыОперацийЗаявок.СРозничногоСклада )	Тогда
				Если ТекущийДокумент.ЗаявкаВзятаВРаботу = 1 Тогда
					Выплатили = 5;
				//ИначеЕсли (ТекущийДокумент.ЗаявкаПеремещена = 0)
				//и (ТекущийДокумент.ЗаявкаВзятаВРаботу = 0)
				//и (ТекущийДокумент.ЗаявкаОбработана = 0) Тогда
				//	Выплатили = 0;
				Иначе
					Выплатили = 0;
				КонецЕсли;
			ИначеЕсли ТекущийДокумент.ВидОперации = Перечисление.ВидыОперацийЗаявок.Неподтвержденная  Тогда
				ТЗ 	= СоздатьОбъект("ТаблицаЗначений");
				Рег	= СоздатьОбъект("Регистр.ЗаявкиНаСклад");
				Рег.УстановитьФильтр(ТекущийДокумент,,);
				Рег.ВыгрузитьИтоги(ТЗ,1,1);
				
				Рег2	= СоздатьОбъект("Регистр.ЗаявкиНаСкладОтгружено");
				
				ТЗ.Свернуть("Заявка","КоличествоОбработано,КоличествоВОбработке");
				ТаблицаДокумента = СоздатьОбъект("ТаблицаЗначений");
				ТекущийДокумент.ВыгрузитьТабличнуюЧасть(ТаблицаДокумента);
				ВсегоКоличество = ТаблицаДокумента.Итог("Количество");
				ВсегоОбработано = ТЗ.Итог("КоличествоОбработано");
				ВсегоВОбработке = ТЗ.Итог("КоличествоВОбработке"); 
				ВсегоОтгружено	 	= Рег2.СводныйИтог(ТекущийДокумент,,,"КоличествоОтгружено");
				Если (ВсегоВОбработке = 0) и (ВсегоОбработано = 0) и (ВсегоОтгружено = 0) Тогда
					Выплатили = 0;
				//ИначеЕсли ВсегоОтгружено = ВсегоКоличество Тогда
				//	Выплатили = 6;
				//ИначеЕсли ((ВсегоОбработано + ВсегоОтгружено) > 0) и ((ВсегоОбработано + ВсегоОтгружено) <> ВсегоКоличество) Тогда 
				//	Выплатили = 7;
				Иначе
					Выплатили = 5;
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
		Возврат Выплатили;
	ИначеЕсли Режим = 2 Тогда
		Если ( ТекущийДокумент.Вид() = "ЗаявкаПокупателя" )  Тогда
			Если ( ТекущийДокумент.ВидОперации = Перечисление.ВидыОперацийЗаявок.НаСклад ) ИЛИ 
			( ТекущийДокумент.ВидОперации = Перечисление.ВидыОперацийЗаявок.СРозничногоСклада )	Тогда
				Если  ТекущийДокумент.ЗаявкаОбработана = 1 Тогда
					Если  ТекущийДокумент.Итог("Количество") = ТекущийДокумент.Итог("КоличествоФакт") Тогда
						Возврат  5; 
					Иначе
						Возврат  7; 
					КонецЕсли;	
				Иначе
					Возврат  0;
				КонецЕсли;
			ИначеЕсли ТекущийДокумент.ВидОперации = Перечисление.ВидыОперацийЗаявок.Неподтвержденная  Тогда
				ТЗ 	= СоздатьОбъект("ТаблицаЗначений");
				Рег	= СоздатьОбъект("Регистр.ЗаявкиНаСклад");
				Рег.УстановитьФильтр(ТекущийДокумент,,);
				Рег.ВыгрузитьИтоги(ТЗ,1,1);
				
				Рег2	= СоздатьОбъект("Регистр.ЗаявкиНаСкладОтгружено");
				
				ТЗ.Свернуть("Заявка","КоличествоОбработано,КоличествоВОбработке");
				ТаблицаДокумента = СоздатьОбъект("ТаблицаЗначений");
				ТекущийДокумент.ВыгрузитьТабличнуюЧасть(ТаблицаДокумента);
				ВсегоКоличество = ТаблицаДокумента.Итог("Количество");
				ВсегоОбработано = ТЗ.Итог("КоличествоОбработано");
				ВсегоВОбработке = ТЗ.Итог("КоличествоВОбработке"); 
				ВсегоОтгружено	= Рег2.СводныйИтог(ТекущийДокумент,,,"КоличествоОтгружено");
				
				Если (ВсегоВОбработке = 0) и (ВсегоОбработано = 0) и (ВсегоОтгружено = 0) Тогда
					Выплатили = 0;
				ИначеЕсли (ВсегоОтгружено = ВсегоКоличество) или (ВсегоОбработано = ВсегоКоличество)
				или ((ВсегоОбработано + ВсегоОтгружено) = ВсегоКоличество) Тогда
					Выплатили = 5;
				ИначеЕсли ((ВсегоОбработано <> 0) или (ВсегоОтгружено <> 0))
				и ((ВсегоОбработано + ВсегоОтгружено) <> ВсегоКоличество) Тогда
					Выплатили = 7;
				Иначе
					Выплатили = 0;
				КонецЕсли;	
			КонецЕсли;
			Возврат Выплатили;
		КонецЕсли;
		Если ТекущийДокумент.Вид() = "Реализация" Тогда
			Выплатили = 0;
			Док= СоздатьОбъект("Документ"); 
			Док.ВыбратьПодчиненныеДокументы(,,ТекущийДокумент);
			Пока Док.ПолучитьДокумент() = 1  Цикл
				Если ( Док.Вид() = "РКО" ) И ( Док.Проведен() = 1 ) Тогда
					Выплатили = 5;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Возврат Выплатили;             
		КонецЕсли;
	ИначеЕсли Режим = 3 Тогда
		Если (ТекущийДокумент.Вид() = "Реализация")  Тогда 
			Если ТекущийДокумент.ЕстьДокументы = 1 Тогда
				Возврат 5;
			Иначе
				Возврат 0;
			КонецЕсли;	
		КонецЕсли;
	ИначеЕсли Режим = 4 Тогда
		Если (ТекущийДокумент.Вид() = "Реализация")  Тогда 
			Если ТекущийДокумент.ДокументыСданы = 1 Тогда
				Возврат 5;
			Иначе
				Возврат 0;
			КонецЕсли;	
		КонецЕсли;	
	КонецЕсли;
КонецФункции


Процедура ПриВыбореЗакладки(Номер)
	Форма.ИспользоватьСлой("Основной", 2); 
	Форма.СуммаРеализации.Видимость(0);
	Форма.ЭкспортБух.Видимость(1);	//Для экспорта в Катину базу
	
	Если Номер = 1  Тогда
		УстановитьОтбор("жПокуп",1);
		Форма.Сумма.Видимость(0);                   
		Форма.СуммаРеализации.Видимость(1);
	//ИначеЕсли Номер = 3  Тогда
	//	Форма.ИспользоватьСлой("Основной,Склад", 2);
	//	УстановитьОтбор("ВидЗаявки",Перечисление.ВидыОперацийЗаявок.НаСклад);
	ИначеЕсли Номер = 3  Тогда //опт
		Форма.ИспользоватьСлой("Основной,Склад", 2);
		проба		= СоздатьОбъект("Справочник.ОтборРознДокум");
		ЭР = сокрЛП(Перечисление.ВидыОперацийЗаявок.НаСклад)+"Опт";
		Если проба.НайтиПоНаименованию(сокрЛП(ЭР),0,1)=1 Тогда
			Отб			= проба.ТекущийЭлемент();
		Иначе
			Отб			= "";
		КонецЕсли;
		УстановитьОтбор("ВидТипДокументаРозницаБезСклада",Отб);
	//ИначеЕсли Номер = 5  Тогда //розн.
	//	Форма.ИспользоватьСлой("Основной,Склад", 2);
	//	проба		= СоздатьОбъект("Справочник.ОтборРознДокум");
	//	ЭР = сокрЛП(Перечисление.ВидыОперацийЗаявок.НаСклад)+"Розница";
	//	Если проба.НайтиПоНаименованию(сокрЛП(ЭР),0,0)=1 Тогда
	//		Отб			= проба.ТекущийЭлемент();
	//	Иначе
	//		Отб			= "";
	//	КонецЕсли;
	//	УстановитьОтбор("ВидТипДокументаРозницаБезСклада",Отб);
	//ИначеЕсли Номер = 5  Тогда //перем.
	//	Форма.ИспользоватьСлой("Основной,Склад", 2);
	//	проба		= СоздатьОбъект("Справочник.ОтборРознДокум");
	//	ЭР = сокрЛП(Перечисление.ВидыОперацийЗаявок.НаСклад)+"Перемещение";
	//	Если проба.НайтиПоНаименованию(сокрЛП(ЭР),0,0)=1 Тогда
	//		Отб			= проба.ТекущийЭлемент();
	//	Иначе
	//		Отб			= "";
	//	КонецЕсли;
	//	УстановитьОтбор("ВидТипДокументаРозницаБезСклада",Отб);
	ИначеЕсли Номер = 2  Тогда
		УстановитьОтбор("ВидЗаявки",Перечисление.ВидыОперацийЗаявок.Неподтвержденная);
		Форма.Сумма.Видимость(1);                   
	ИначеЕсли Номер = 4  Тогда                   
		УстановитьОтбор("Реализация");
		Форма.Сумма.Видимость(0);                   
		Форма.СуммаРеализации.Видимость(1);
		Форма.ЭкспортБух.Видимость(1);
	ИначеЕсли Номер = 5  Тогда                   
		Форма.ИспользоватьСлой("Основной,Клиент", 2);
		УстановитьОтбор("Покупатель",ВыбКлиент);
	//ИначеЕсли Номер = 8  Тогда                   
	//	УстановитьОтбор("НетВНаличии");
	//ИначеЕсли Номер = 9  Тогда                   
	//	УстановитьОтбор("ВидЗаявки",Перечисление.ВидыОперацийЗаявок.СРозничногоСклада);
	КонецЕсли;
КонецПроцедуры	


Процедура ПриОткрытии()
	
	Форма.ИспользоватьЗакладки(1);
	Форма.Закладки.ДобавитьЗначение("Общий");						//1
	Форма.Закладки.ДобавитьЗначение("Неподтвержденные");			//2
	//Форма.Закладки.ДобавитьЗначение("Заявки на склад");		
	Форма.Закладки.ДобавитьЗначение("Заявки на склад (опт)");		//3
	//Форма.Закладки.ДобавитьЗначение("Заявки на склад (розн.)");	
	//Форма.Закладки.ДобавитьЗначение("Заявки на склад (перем.)");	
	Форма.Закладки.ДобавитьЗначение("Реализация");					//4
	
	Форма.Закладки.ДобавитьЗначение("Отбор по клиенту");			//5
//	Форма.Закладки.ДобавитьЗначение("Нет в наличии");				
//	Форма.Закладки.ДобавитьЗначение("С Розничного склада");			
	
	Если сокрЛП(глПользователь.Полномочия)<>"Бухгалтер" тогда	//нефиг остальным лазить
		Форма.Выгр.Доступность(0);
	КонецЕсли; 
      
	Если ((глПользователь.Код<>"Кожемякин") и (глПользователь.Код<>"Пикта") и (глПользователь.Код<>"Жук") и (глПользователь.Код<>"ОптМенеджер3") и (глПользователь.Код<>"ОфисМенеджер")) Тогда
		Форма.КнПолучитьEDI.Доступность(0); 
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОтчётБН()
	ОткрытьФорму("Отчет.ДанныеООплатахПоБН");
КонецПроцедуры


Процедура ЗадатьФлагЭкспорта()	//Сформировать флаг экспорта для текущего документа
	Если ТекущийДокумент.ПредставлениеВида()="Реализация " тогда
		ТД=СоздатьОбъект("Документ.Реализация");
		если ТД.НайтиПоНомеру(ТекущийДокумент.НомерДок,ТекущийДокумент.ДатаДок)=1 тогда
			Если ТД.ЭкспортБух=0 тогда
				ТД.ЭкспортБух=1;
				ТД.Записать();
			иначе
				ТД.ЭкспортБух=0;
				ТД.Записать();
			КонецЕсли;
		иначе
			сообщить("Не могу выбрать Документ...Возможно он уже открыт!!!");
		КонецЕсли;
	конецЕсли;
	
	
	Форма.Обновить();
конецПроцедуры

//Валерий МЭТР
Процедура ПечатьСводныйРеестр()

	КонтекстФормы = СоздатьОбъект("СписокЗначений");
	КонтекстФормы.ДобавитьЗначение(НачалоИнтервала());
	КонтекстФормы.ДобавитьЗначение(КонецИнтервала());
	ОткрытьФорму("Отчет.СводныйРеестр",КонтекстФормы);
	
КонецПроцедуры


УстановитьОтбор("жПокуп",1);

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ
//
//Инициализирум список действий по кнопке "Действия"
СписокДействий = СоздатьОбъект("СписокЗначений");
СписокДействий.ДобавитьЗначение("Структура подчиненности");
СписокДействий.ДобавитьЗначение("Отчет о движениях документа");  
СписокДействий.ДобавитьЗначение("Отчет о бухгалтерских проводках");
СписокДействий.ДобавитьЗначение("Ввести на основании");
СписокДействий.ДобавитьЗначение("Скопировать в...");         

Форма.ИспользоватьСлой("Основной", 2);
	Форма.СуммаРеализации.Видимость(0);
	ПриВыбореЗакладки(1)
