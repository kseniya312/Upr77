////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ
// 
Перем СписокДействий;  // Список действий по документу
Перем СписокВидовДокументов;
Перем КонтрагентДляОтбора, ФирмаДляОтбора, ЮрЛицоДляОтбора, 
      СкладДляОтбора, ВидДокументаДляОтбора, АвторДляОтбора, ПроектДляОтбора, ПравильныйОтбор; // Переменные для отбора
Перем ЗначениеВВидеСтроки;

Перем ДокументОснованиеЖурнала; // если пустое, то открыта обычная форма журнала,
                                // иначе текущий документ, которому подчинен журнал

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ МОДУЛЯ
// 
//******************************************************************************
// ПолучитьВремяДокументаЧислом(Док)
//
// Параметры: 
//  Док - документ, чьё время надо получить
//
// Возвращаемое значение:
//  Нет
//
// Описание:
//  Преобразует время документа в число.
//
Функция ПолучитьВремяДокументаЧислом(Док)
    Перем Ч,М,С;  
	Док.ПолучитьВремя(Ч,М,С);
	Возврат 3600*Ч+60*М+С;
КонецФункции // ПолучитьВремяДокументаЧислом()

//******************************************************************************
// УстановитьВремяДокументаЧислом(Док, Сек)
//
// Параметры: 
//  Док - документ, чьё время надо установить
//  Сек - число, новое время документа в секундах (с начала дня)
//
// Возвращаемое значение:
//  Нет
//
// Описание:
//  Устанавливает новое время документа.
//
Процедура УстановитьВремяДокументаЧислом(Док, Сек)
    Перем Ч,М,С;
	Ч=Цел(Сек/3600);
	Сек=Сек-Ч*3600;
	М=Цел(Сек/60);
	С=Сек-М*60;
	Док.УстановитьВремя(Ч,М,С);
КонецПроцедуры // УстановитьВремяДокументаЧислом()

Функция Пиктограмма()
	Перем НомПикт;
	
	Если ТекущийДокумент.Выбран() = 1 Тогда  
		
		ТекДок=ТекущийДокумент;
		Если ТекДок.Отработан=1 Тогда
			НомПикт = 1;
		Иначе
			НомПикт = 2;
		КонецЕсли;
	Иначе
		НомПикт = 0; // Если в строке нет документа возвращаем 0, то есть картинки не будет.
	КонецЕсли;
	Возврат НомПикт;
КонецФункции

Функция Пиктограмма2()
	Перем НомПикт;
	
	Если ТекущийДокумент.Выбран() = 1 Тогда  
		
		Попытка
			ТекДок=ТекущийДокумент;
			Если ТекДок.Отработан_опт=1 Тогда
				НомПикт = 1;
			Иначе
				НомПикт = 2;
			КонецЕсли;
		Исключение
		КонецПопытки;		
	Иначе
		НомПикт = 0; // Если в строке нет документа возвращаем 0, то есть картинки не будет.
	КонецЕсли;
	Возврат НомПикт;
КонецФункции

//******************************************************************************
// ПоКнопкеВремя()
//
// Параметры: 
//  Нет
//
// Возвращаемое значение:
//  Нет
//
// Вызывается из формул элементов диалога
//  Пок кнопке "Время".
// 
// Описание:
//  Отрабатывает нажатие кнопки "Время".
//  Служит для изменения времени документа в пределах дня.
//
Процедура ПоКнопкеВремя()
	
	ТекДок=ТекущийДокумент;       
	Если ТекДок.Выбран()=0 Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекДок.ДатаДок <= Константа.ДатаЗапретаРедактирования Тогда
	    
		Предупреждение("Нельзя изменять документы с датой, более ранней чем дата запрета редактирования документов!",60);
		Возврат;
	КонецЕсли;

	
	Меню=СоздатьОбъект("СписокЗначений");
	Меню.ДобавитьЗначение("Назад",  "Переместить назад");
	Меню.ДобавитьЗначение("Вперед", "Переместить вперед");
	Меню.ДобавитьЗначение("ВНачало","Переместить в начало дня");
	Меню.ДобавитьЗначение("ВКонец", "Переместить в конец дня");
	
	Вариант="";
	Если Меню.ВыбратьЗначение(Вариант,,,,1)=0 Тогда
		Возврат;
	КонецЕсли;	
	
	Док=СоздатьОбъект("Документ");
	
	Попытка;
		НачатьТранзакцию();
		
		Если Вариант="Назад" Тогда
			Док.ОбратныйПорядок(1);
			Док.ВыбратьДокументы(ТекДок.ДатаДок,СформироватьПозициюДокумента(ТекДок.ПолучитьПозицию(),-1));               
			Если Док.ПолучитьДокумент()=0 Тогда
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;
			Время2=ПолучитьВремяДокументаЧислом(Док);
			Если Док.ПолучитьДокумент()=1 Тогда
				Время1=ПолучитьВремяДокументаЧислом(Док);
			Иначе
				Время1=0;
			КонецЕсли;
			Время=Время2-60;
			Если Время<=Время1 Тогда
				Время=Окр((Время2+Время1)/2);
			КонецЕсли;
			Если (Время<=Время1) или (Время>=Время2) Тогда
				Предупреждение("Нет возможности переставить документ!", 60);
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;
		ИначеЕсли Вариант="Вперед" Тогда
			Док.ОбратныйПорядок(0);
			Док.ВыбратьДокументы(СформироватьПозициюДокумента(ТекДок.ПолучитьПозицию(),1),ТекДок.ДатаДок);               
			Если Док.ПолучитьДокумент()=0 Тогда
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;
			Время1=ПолучитьВремяДокументаЧислом(Док);
			Если Док.ПолучитьДокумент()=1 Тогда
				Время2=ПолучитьВремяДокументаЧислом(Док);
			Иначе
				Время2=3600*23+60*59+59+1;
			КонецЕсли;
			Время=Время1+60;
			Если Время>=Время2 Тогда
				Время=Окр((Время2+Время1)/2);
			КонецЕсли;
			Если (Время<=Время1) или (Время>=Время2) Тогда
				Предупреждение("Нет возможности переставить документ!", 60);
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;
		ИначеЕсли Вариант="ВНачало" Тогда
			Док.ОбратныйПорядок(0);
			Док.ВыбратьДокументы(ТекДок.ДатаДок,СформироватьПозициюДокумента(ТекДок.ПолучитьПозицию(),-1));               
			Если Док.ПолучитьДокумент()=0 Тогда
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;                 
			Время2=ПолучитьВремяДокументаЧислом(Док);
			Время1=0;
			Время=Время2-60;
			Если Время<=Время1 Тогда
				Время=Окр((Время2+Время1)/2);
			КонецЕсли;
			Если (Время<=Время1) или (Время>=Время2) Тогда
				Предупреждение("Нет возможности переставить документ!", 60);
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;
		ИначеЕсли Вариант="ВКонец" Тогда
			Док.ОбратныйПорядок(1);
			Док.ВыбратьДокументы(СформироватьПозициюДокумента(ТекДок.ПолучитьПозицию(),1),ТекДок.ДатаДок);               
			Если Док.ПолучитьДокумент()=0 Тогда
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;                 
			Время1=ПолучитьВремяДокументаЧислом(Док);
			Время2=3600*23+60*59+59+1;
			Время=Время1+60;
			Если Время>=Время2 Тогда
				Время=Окр((Время2+Время1)/2);
			КонецЕсли;
			Если (Время<=Время1) или (Время>=Время2) Тогда
				Предупреждение("Нет возможности переставить документ!", 60);
				ОтменитьТранзакцию();
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		Провести=0;	
		Док.НайтиДокумент(ТекДок);
		Если Док.Проведен()=1 Тогда
			Док.СделатьНеПроведенным();
			Провести=1;	
		КонецЕсли;
		
		УстановитьВремяДокументаЧислом(Док,Время);	
		Док.Записать();
		
		Если Провести=1 Тогда
			Док.Провести();
		КонецЕсли;         
		
		ЗафиксироватьТранзакцию();
	Исключение
		Сообщить(ОписаниеОшибки(),"!");  
	КонецПопытки;
	
КонецПроцедуры // ПоКнопкеВремя()


//******************************************************************************
// РедактироватьРеквизиты()
//
// Параметры:
//  Нет
//
// Вызывается из формул элементов диалога:
//  Кнопка "Редактировать реквизиты документа".
//
// Описание:
//  Окрывает на редактирование документ.
//
Процедура РедактироватьРеквизиты()
	
	ОткрытьФорму("Отчет.РедактированиеРеквизитовДокумента#" + ЗначениеВСтрокуВнутр(ТекущийДокумент), ТекущийДокумент);
	
КонецПроцедуры // РедактироватьРеквизиты()

//******************************************************************************
//******************************************************************************
// ПриОбычномОткрытииЖурнала()
//
// Параметры: 
//  Нет
//
// Возвращаемое значение:
//  Нет
//
// Описание:
//  Выполняет необходимые действия при обычном открытии журнала
//
Процедура ПриОбычномОткрытииЖурнала()
	
	
КонецПроцедуры // ПриОбычномОткрытииЖурнала()


//******************************************************************************
// ПриОткрытииИЛИПереоткрытииЖурнала(Режим)
//
// Параметры: 
//  Режим - Строка режима открытия ("Открытие" или "Переоткрытие") формы журнала
//
// Возвращаемое значение:
//  Нет
//
// Описание:
//  Выполняет необходимые действия при открытии журнала
//
Процедура ПриОткрытииИЛИПереоткрытииЖурнала(Режим)
	
	// запомним документ основание для формы журнала подчиненных документов
	ДокументОснованиеЖурнала = ПодчинениеДокументу();
	
	Если Режим="Открытие" Тогда
		// Позиционируемся на последнем документе
		ТекДок = ВосстановитьЗначение("ТекДок");
		ТекДок = ?(ПустоеЗначение(ТекДок)=1, ПолучитьПустоеЗначение("Документ"), ТекДок);
			
		//Заполним список действий по кнопке "Действия"
		СписокДействий.УдалитьВсе();
//		СписокДействий.ДобавитьЗначение("Отчет о движениях документа");
//		СписокДействий.ДобавитьЗначение("Отчет о бухгалтерских проводках");
		СписокДействий.ДобавитьЗначение("Структура подчиненности");
//		СписокДействий.ДобавитьЗначение("Ввести на основании");

		Если ТипЗначенияСтр(ДокументОснованиеЖурнала) = "Документ" Тогда // форма журнала подчиненных документов
			Форма.Заголовок("Журнал подчиненных документов к документу " + глПредставлениеДокумента(ДокументОснованиеЖурнала));
			
			// менять время документов и распечатывать реестр в журнале подчиненных считаем не нужным
			Форма.кнВремя. Доступность(0);
			Форма.кнРеестр.Доступность(0);
			
		Иначе	// Обычная форма журнала                        
			
//			СписокДействий.ДобавитьЗначение("Скопировать в...");
			Форма.Заголовок("",1);
			// Определение был ли быстрый отбор
			ТекСтр = ?(ПустоеЗначение(ТекСтр)=1, 1, ТекСтр);
		
			ПриОбычномОткрытииЖурнала();
		КонецЕсли;
		
		
	ИначеЕсли Режим="Переоткрытие" Тогда	
		ТекДок = ТекущийДокумент;
	КонецЕсли;	
			
	Если ПустоеЗначение(Форма.Параметр)=0 Тогда
		Если ВРег(ТипЗначенияСтр(Форма.Параметр))="ДОКУМЕНТ" Тогда
			// НАДО ПОЗИЦИОНИРОВАТЬСЯ НА ЭТОМ ДОКУМЕНТЕ
			Док = Форма.Параметр.ТекущийДокумент();
			Если Док.Выбран()>0 Тогда 
				ТекДок = Док;
	
				// Если документ не попадает в текущий интервал журнала, то изменим интервал 
				ДатаНач = Мин(НачалоИнтервала(), Док.ДатаДок);
				ДатаКон = Макс(КонецИнтервала(), Док.ДатаДок);
				УстановитьИнтервал(ДатаНач,ДатаКон);
				
			КонецЕсли; // Док.Выбран()>0	
		КонецЕсли; // ВРег(ТипЗначенияСтр(Форма.Параметр))="ДОКУМЕНТ"      
	КонецЕсли; // ПустоеЗначение(Форма.Параметр)=0
	
	Попытка
		АктивизироватьОбъект(ТекДок);
	Исключение	
		Сообщить(ОписаниеОшибки(),"!");
	КонецПопытки;	
		
КонецПроцедуры // ПриОткрытииИЛИПереоткрытииЖурнала()

////////////////////////////////////////////////////////////////////////////////
// ПРЕДОПРЕДЕЛЕННЫЕ ПРОЦЕДУРЫ
// 
//******************************************************************************
// Предопределенная процедура.
//
Процедура ПриПовторномОткрытии()
	
	ПриОткрытииИЛИПереоткрытииЖурнала("Переоткрытие");
	
КонецПроцедуры // ПриПовторномОткрытии()

//******************************************************************************
// Предопределенная процедура.
//
Процедура ПриОткрытии()  
	
	ПриОткрытииИЛИПереоткрытииЖурнала("Открытие");
	
	
КонецПроцедуры // ПриОткрытии()

//******************************************************************************
// Предопределенная процедура.
//
Процедура ПриЗакрытии()
	
	СохранитьЗначение("ТекДок",ТекущийДокумент);
		
КонецПроцедуры // ПриЗакрытии()

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ
// 
//Инициализирум список действий по кнопке "Действия"
СписокДействий = СоздатьОбъект("СписокЗначений");
	                  
