// используются для стандартного механизма кнопок "Обновить" и "Настройка"
Перем Таб;		
Перем Обновить;
Перем Расшифровка; 
Перем ВыбирайГруппу;                        

Процедура Сформировать() далее


Функция РасшифровкаОбновить(Обновить)
	Расшифровка.Установить("Обновить", Обновить);
	Возврат Расшифровка;
КонецФункции //РасшифровкаОбновить()                                            

процедура ПриОткрытии()
	Обновить=глОбновить;
	
	Если Обновить <> 0 Тогда
		Таб = глТаблица;
	КонецЕсли;           

	Если Обновить=1 тогда
		ВыбНачПериода 		= глРасшифровка.Получить("ВыбНачПериода");
		ВыбКонПериода 		= глРасшифровка.Получить("ВыбКонПериода");
		ВыбКонтрагент 		= глРасшифровка.Получить("ВыбКонтрагент");
		//Проверим исключённых	
		а	= СоздатьОбъект("СписокЗначений");
		а	= глРасшифровка.Получить("СписокИсключенных");
		если а.РазмерСписка()>0 Тогда
			СписокИсключенных.УдалитьВсе();
			сп	= "";
			для к = 1 по а.РазмерСписка() Цикл
				СписокИсключенных.ДобавитьЗначение(а.ПолучитьЗначение(к,сп),сп);
			КонецЦикла;
		КонецЕсли;
		Сформировать();
		СтатусВозврата(0);
		Возврат;
	КонецЕсли;
	Обновить=0;
	
КонецПроцедуры

//*******************************************
// Процедура генерации запроса Сформировать.
//
Процедура Сформировать()
	Перем Запрос, ТекстЗапроса, Х, У;
	
	Если глПроверкаДаты(ВыбНачПериода,ВыбКонПериода)=0 Тогда
		Возврат;
	КонецЕсли;
	
	Если (ТипЗначенияСтр(Таб) <> "Таблица") ИЛИ (Обновить = 0) Тогда
		Таб = СоздатьОбъект("Таблица");
	Иначе
		Таб.Очистить();
	КонецЕсли;      
	
	Состояние("Подбираем клиентов в выборку");
	
	
	темп=СоздатьОбъект("СписокЗначений");
	
	если СписокИсключенных.РазмерСписка()=0 Тогда
		ВыбКонтрагент1	= ВыбКонтрагент;
	Иначе
		//Заменяем группы на элементы
		сп=СписокИсключенных.РазмерСписка();
		для у=1 по сп Цикл
			а=СписокИсключенных.ПолучитьЗначение(у);
			если а.ЭтоГруппа()=1 тогда
				спр=СоздатьОбъект("Справочник.Контрагенты");
				спр.ИспользоватьРодителя(а);
				спр.ВыбратьЭлементы();
				пока спр.ПолучитьЭлемент()=1 Цикл
					врем = спр.ТекущийЭлемент();
					если (врем.ЭтоГруппа()=0) и (СписокИсключенных.НайтиЗначение(врем)=0) Тогда
						темп.ДобавитьЗначение(спр.ТекущийЭлемент());
					КонецЕсли;
				КонецЦикла;
			Иначе
				темп.ДобавитьЗначение(а);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	
	
	//*********************
	ВыбКонтрагент1	= СоздатьОбъект("СписокЗначений");
	спр=СоздатьОбъект("Справочник.Контрагенты");
	если ВыбКонтрагент.ЭтоГруппа()=1 Тогда
		спр.ИспользоватьРодителя(ВыбКонтрагент);
		спр.ВыбратьЭлементы();
		пока спр.ПолучитьЭлемент()=1 Цикл
			врем = спр.ТекущийЭлемент();
			если (врем.ЭтоГруппа()=0) и (темп.НайтиЗначение(врем)=0) Тогда
				ВыбКонтрагент1.ДобавитьЗначение(спр.ТекущийЭлемент());
			КонецЕсли;
		КонецЦикла;
	ИначеЕсли пустоеЗначение(ВыбКонтрагент)=0 Тогда
		ВыбКонтрагент1	= ВыбКонтрагент;
	ИначеЕсли (пустоеЗначение(ВыбКонтрагент)=1) и (СписокИсключенных.размерСписка()=0) Тогда
		ВыбКонтрагент1	= ВыбКонтрагент;
	иначеесли пустоеЗначение(ВыбКонтрагент)=1 Тогда
		спр.выбратьЭлементы(0);
		пока спр.ПолучитьЭлемент()=1 Цикл
			врем = спр.ТекущийЭлемент();
			если (врем.ЭтоГруппа()=0) и (темп.НайтиЗначение(врем)=0) Тогда
				ВыбКонтрагент1.ДобавитьЗначение(спр.ТекущийЭлемент());
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Состояние("Начинаем разгребать запрос");
	
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(Сформировать)
	|Период с ВыбНачПериода по ВыбКонПериода;
	|Обрабатывать НеПомеченныеНаУдаление;
	|Контрагент 	= Регистр.Взаиморасчеты2.Контрагент;
	|Долг 			= Регистр.Взаиморасчеты2.Долг;
	|Скидка 		= Регистр.Взаиморасчеты2.Скидка;
	|ВидОплаты 		= Регистр.Взаиморасчеты2.ВидОплаты;
	|Валюта 		= Регистр.Взаиморасчеты2.Валюта;
	|Договор		= Регистр.Взаиморасчеты2.ТекущийДокумент.Реализация.Договор,
	|				  Регистр.Взаиморасчеты2.ТекущийДокумент.СтрокаВыпискиПриход.Договор,
	|				  Регистр.Взаиморасчеты2.ТекущийДокумент.ПКО.Договор;
	|Функция ДолгНачОст = НачОст(Долг);
	|Функция ДолгПриход = Приход(Долг);
	|Функция ДолгРасход = Расход(Долг);
	|Функция ДолгКонОст = КонОст(Долг);
	|Функция СкидкаНачОст = НачОст(Скидка);
	|Функция СкидкаПриход = Приход(Скидка);
	|Функция СкидкаРасход = Расход(Скидка);
	|Функция СкидкаКонОст = КонОст(Скидка);
	|Группировка Контрагент без групп;
	|Группировка Валюта без групп;
	|Группировка ВидОплаты без групп;
	|Группировка Документ;
	|Условие(Контрагент в ВыбКонтрагент1);
	|Условие(ПустоеЗначение(Валюта)<>1);";
	Если СписокВидовДоговоров.ТекущаяСтрока() <> 1 Тогда // по видам договоров
		ВидДоговора = СписокВидовДоговоров.получитьЗначение(СписокВидовДоговоров.ТекущаяСтрока());
		ТекстЗапроса = ТекстЗапроса + РазделительСтрок+
		"Условие (Найти(Договор.Наименование,ВидДоговора)<>0);";
	КонецЕсли;
	//|"//}}ЗАПРОС
	//;
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;
	
	если флаж=1 Тогда	//Типа в рубликах нам надо
		валют=глРубли;
	Иначе
		валют=глДоллары;
	КонецЕсли;
	// Подготовка к заполнению выходных форм данными запроса
	//******************************************************************************
	//		Подготавливаем суммы
	Вал=СоздатьОбъект("ТаблицаЗначений");
	Вал.НоваяКолонка("Контрагент","Справочник.Контрагенты");
	Вал.НоваяКолонка("ДолгНачОст","число",12,2);
	Вал.НоваяКолонка("ДолгПриход","число",12,2);
	Вал.НоваяКолонка("ДолгРасход","число",12,2);
	Вал.НоваяКолонка("ДолгКонОст","число",12,2);
	Вал.НоваяКолонка("СкидкаНачОст","число",12,2);
	Вал.НоваяКолонка("СкидкаПриход","число",12,2);
	Вал.НоваяКолонка("СкидкаРасход","число",12,2);
	Вал.НоваяКолонка("СкидкаКонОст","число",12,2);
	
	ДолгНачОстИ=0;ДолгПриходИ=0;ДолгРасходИ=0;ДолгКонОстИ=0;
	СкидкаНачОстИ=0;СкидкаПриходИ=0;СкидкаРасходИ=0;СкидкаКонОстИ=0;
	Пока Запрос.Группировка(1) = 1 Цикл
		Вал.НоваяСтрока();
		Вал.Контрагент=Запрос.Контрагент;
		Состояние("Подготавливаем данные по: "+Вал.Контрагент);
		ДолгНач=0;ДолгКон=0;
		ДолгПриход=0;ДолгРасход=0;
		СкидкаНач=0;СкидкаКон=0;
		СкидкаПриход=0;СкидкаРасход=0;
		Пока Запрос.Группировка(2) = 1 Цикл	//Набираем по каждой валюте
			ДолгНач		= ДолгНач	+ глПересчет(Запрос.ДолгНачОст,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			ДолгПриход	= ДолгПриход+ глПересчет(Запрос.ДолгПриход,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			ДолгРасход	= ДолгРасход+ глПересчет(Запрос.ДолгРасход,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			ДолгКон		= ДолгКон	+ глПересчет(Запрос.ДолгКонОст,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			
			СкидкаНач	= СкидкаНач		+ глПересчет(Запрос.СкидкаНачОст,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			СкидкаПриход= СкидкаПриход	+ глПересчет(Запрос.СкидкаПриход,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			СкидкаРасход= СкидкаРасход	+ глПересчет(Запрос.СкидкаРасход,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
			СкидкаКон	= СкидкаКон		+ глПересчет(Запрос.СкидкаКонОст,Запрос.Валюта,ВыбКонПериода,валют,ВыбКонПериода);
		КонецЦикла;
		Вал.ДолгНачОст	= ДолгНач;
		Вал.ДолгКонОст	= ДолгКон;
		Вал.ДолгПриход	= ДолгПриход;
		Вал.ДолгРасход	= ДолгРасход;	
		
		Вал.СкидкаНачОст= СкидкаНач;	
		Вал.СкидкаКонОст= СкидкаКон;
		Вал.СкидкаПриход= СкидкаПриход;
		Вал.СкидкаРасход= СкидкаРасход;	
		
		//ИТОГО
		ДолгНачОстИ		= ДолгНачОстИ+ДолгНач;
		ДолгПриходИ		= ДолгПриходИ+ДолгПриход;
		ДолгРасходИ		= ДолгРасходИ+ДолгРасход;
		ДолгКонОстИ		= ДолгКонОстИ+ДолгКон;
		
		СкидкаНачОстИ	= СкидкаНачОстИ+СкидкаНач;
		СкидкаПриходИ	= СкидкаПриходИ+СкидкаПриход;
		СкидкаРасходИ	= СкидкаРасходИ+СкидкаРасход;
		СкидкаКонОстИ	= СкидкаКонОстИ+СкидкаКон;
	КонецЦикла;
	//******************************************************************************
	//		Выводим данные	
	Запрос.вНачалоВыборки();	//Возвращаем в начало выборки
	//		Таб = СоздатьОбъект("Таблица");
	если ПолныйВид=1 Тогда
		Таб.ИсходнаяТаблица("Сформировать");
	Иначе
		Таб.ИсходнаяТаблица("Урезанная");
	КонецЕсли;
	
	Расшифровка = СоздатьОбъект("СписокЗначений");
	Расшифровка.Установить("Отчет", "Взаиморасчёты");
	
	// все настройки помещаем в список
	Расшифровка.Установить("ВыбНачПериода",		ВыбНачПериода);
	Расшифровка.Установить("ВыбКонПериода",		ВыбКонПериода);
	Расшифровка.Установить("ВыбКонтрагент",		ВыбКонтрагент);
	Расшифровка.Установить("СписокИсключенных", СписокИсключенных);
	
	Таб.ВывестиСекцию("Кнопки");
	Таб.ВывестиСекцию("Заголовок");
	Состояние("Заполнение выходной таблицы...");
	Таб.Опции(0, 0, Таб.ВысотаТаблицы(), 0);
	Вал.ВыбратьСтроки();
	Пока Запрос.Группировка(1) = 1 Цикл
		Вал.получитьСтроку();
		Состояние("Выводим данные по: "+Запрос.Контрагент);
		//если (Вал.ДолгНачОст=0) и (Вал.ДолгПриход=0) и (Вал.ДолгРасход=0) и (Вал.ДолгКонОст=0) и (ПолныйВид=0) 	Тогда
		//	Продолжить;
		//Иначе
		если (Вал.ДолгНачОст=0) и (Вал.ДолгПриход=0) и (Вал.ДолгРасход=0) и (Вал.ДолгКонОст=0)// и (ПолныйВид=1) и
				и (Вал.СкидкаНачОст=0) и (Вал.СкидкаПриход=0) и (Вал.СкидкаРасход=0) и (Вал.СкидкаКонОст=0) 		Тогда
			Продолжить;  
		ИначеЕсли (Вал.ДолгНачОст=0) и (Вал.ДолгПриход=0) и (Вал.ДолгРасход=0) и (Вал.ДолгКонОст=0) и (ПолныйВид=0) Тогда
			Продолжить;
		Иначе
			Таб.ВывестиСекцию("Контрагент");
			если (флаж2=3) или (флаж2=2) или (флаж2=1) Тогда					//До клиента
				Пока Запрос.Группировка(2) = 1 Цикл
					Таб.ВывестиСекцию("Валюта");
					если (флаж2=2) или (флаж2=1) Тогда				//До вида оплаты
						Пока Запрос.Группировка(3) = 1 Цикл
							Таб.ВывестиСекцию("ВидОплаты");
							если флаж2=1 Тогда			//До накладных
								Пока (Запрос.Группировка(4) = 1) Цикл 
									Если (ПолныйВид = 0)
										и (Запрос.ДолгНачОст=0) и (Запрос.ДолгПриход=0) и (Запрос.ДолгРасход=0) и (Запрос.ДолгКонОст=0) Тогда
										Продолжить;
									КонецЕсли;
									
									Докум = Запрос.Документ;
									Договор = "(Договор:"+СокрЛП(Запрос.Договор.Наименование)+")";
									Таб.ВывестиСекцию("Документ");
								КонецЦикла;
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	Таб.ВывестиСекцию("Итоги");
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Взаиморасчёты по клиентам", "");
	
КонецПроцедуры

Процедура ВнестиВСписок()
	
	ОткрытьПодбор("Справочник.Контрагенты","ДляВыбора","ВыбирайГруппу",1);
КонецПроцедуры 

Процедура ОбработкаПодбора(Элемент, КонтФормы)
	//Если Элемент.ЭтоГруппа()=0 Тогда
	Если СписокИсключенных.НайтиЗначение(Элемент.ТекущийЭлемент())=0 Тогда
		СписокИсключенных.ДобавитьЗначение(Элемент.ТекущийЭлемент());
	КонецЕсли;
	//КонецЕсли;
КонецПроцедуры // ОбработкаПодбора()  

ВыбирайГруппу=1;

СписокВидовДоговоров.ДобавитьЗначение("");
СписокВидовДоговоров.ДобавитьЗначение("Бизнес-Сервис");
СписокВидовДоговоров.ДобавитьЗначение("Эксперт");
СписокВидовДоговоров.ДобавитьЗначение("Сан Саныч");
СписокВидовДоговоров.ДобавитьЗначение("Профи");
СписокВидовДоговоров.ДобавитьЗначение("RCO");
СписокВидовДоговоров.ДобавитьЗначение("Основной");

Расшифровка = СоздатьОбъект("СписокЗначений");
Расшифровка.Установить("Отчет", "Взаиморасчёты");


