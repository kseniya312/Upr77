//*******************************************
// Процедура генерации запроса Сформировать.
//
Процедура Сформировать()
	Перем Запрос, ТекстЗапроса, Таб;
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(Сформировать)
	|Период с ВыбНачПериода по ВыбКонПериода;
	|Обрабатывать НеПомеченныеНаУдаление;
	|ТекущийДокумент = Регистр.ПартииНаличие.ТекущийДокумент;
	|ПродСтоимость = Регистр.ПартииНаличие.ПродСтоимость;
	|Количество = Регистр.ПартииНаличие.Количество;
	|СуммаУпр = Регистр.ПартииНаличие.СуммаУпр;
	|СуммаРуб = Регистр.ПартииНаличие.СуммаРуб;
	|КодОперации  = Регистр.ПартииНаличие.КодОперации;
	|Номенклатура = Регистр.ПартииНаличие.Номенклатура;
	|Партия = Регистр.ПартииНаличие.Партия;
	|Поставщик = Регистр.ПартииНаличие.Партия.Поставщик;
	|Функция ПродСтоимостьСумма = Сумма(ПродСтоимость);
	|Функция КоличествоПриход = Приход(Количество);
	|Функция КоличествоРасход = Расход(Количество);
	|Функция СуммаУпрПриход = Приход(СуммаУпр);
	|Функция СуммаУпрРасход = Расход(СуммаУпр);
	|Функция СуммаРубПриход = Приход(СуммаРуб);
	|Функция СуммаРубРасход = Расход(СуммаРуб);
	|Группировка Поставщик без групп;
	|Группировка ТекущийДокумент без групп;
	|"//}}ЗАПРОС
	;    
	//Дополнения к запросу
	Если СокрЛП(ВыбПоставщик)<>"" тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(Поставщик=ВыбПоставщик);";
		КтоТакой=ВыбПоставщик;
	иначе
		КтоТакой="Все";
		КтоТакой=ВыбПоставщик;
	КонецЕсли;
    Если (ВыбТовар<>"") и (Товар<>1) тогда
		сообщить("Поставьте группировку по номенклатуре или очистите поле товар...","!!!");
		возврат;
	КонецЕсли;
	
	Если Товар=1 тогда
		ТекстЗапроса=ТекстЗапроса+"Группировка Номенклатура без групп;";
		Если СокрЛП(ВыбТовар)<>"" тогда
			//			ТекстЗапроса=ТекстЗапроса+"Условие(Номенклатура=ВыбТовар);";
			//			ТекстЗапроса=ТекстЗапроса+"Группировка Номенклатура;";
			ЧёЗаТовар=ВыбТовар;
		иначе
			ЧёЗаТовар="Все позиции поставщика";
		КонецЕсли;
		Если СокрЛП(ВыбТовар)<>"" тогда
			Выб=СоздатьОбъект("Справочник.Номенклатура");
			Значит=СоздатьОбъект("СписокЗначений");
			Выб.ВыбратьЭлементы();
			Если ВыбТовар.ЭтоГруппа()=1 тогда
				Пока Выб.ПолучитьЭлемент()=1 Цикл
					если Выб.ТекущийЭлемент().ПринадлежитГруппе(ВыбТовар)=1 тогда
						Значит.ДобавитьЗначение(Выб.ТекущийЭлемент()); 
					конецесли;
				КонецЦикла;
				ТекстЗапроса=ТекстЗапроса+"Условие(Номенклатура в Значит);";
			иначе
				ТекстЗапроса=ТекстЗапроса+"Условие(Номенклатура=ВыбТовар);";
			КонецЕсли;
		КонецЕсли;
	иначе
		ЧёЗаТовар="Без номенклатуры";
	КонецЕсли;
	Если Перемещения=0 тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.Перемещение);";
	КонецЕсли;
	
	Если Приход=0 тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.Закупка);";
	КонецЕсли;
	Если Расход=0 тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.РозничнаяПродажа);";
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.Продажа);";
	КонецЕсли;
	Если Возвраты=0 тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.ВозвратОтПокупателя);";
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.ВозвратПоставщику);";
	КонецЕсли;
	Если Списание=0 тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.Оприходование);";
		ТекстЗапроса=ТекстЗапроса+"Условие(КодОперации <> глКО.Списание);";
	КонецЕсли;
	
	
	
	
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;
	
	
	// Подготовка к заполнению выходных форм данными запроса
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Сформировать");
	// Заполнение полей "Заголовок"
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Сформировать");
	Таб.ВывестиСекцию("Заголовок");
	Состояние("Заполнение выходной таблицы...");
	Таб.Опции(0, 0, Таб.ВысотаТаблицы(), 0);
	Пока Запрос.Группировка(1) = 1 Цикл
		// Заполнение полей Поставщик
		ПродСтоимостьРуб=Запрос.ПродСтоимостьСумма;
		ПродСтоимостьЕвро=глПересчет(ПродСтоимостьРуб,глРубли,ВыбКонПериода,глДоллары,ВыбКонПериода);
		СуммаРубПрих=Запрос.СуммаРубПриход;
		СуммаРубРасх=Запрос.СуммаРубРасход;
		СуммаЕвроПрих=Запрос.СуммаУпрПриход;
		СуммаЕвроРасход=Запрос.СуммаУпрРасход;
		ВыручкаСуммРуб=ПродСтоимостьРуб-СуммаРубРасх;
		Процент=глФРМ(?(ПродСтоимостьРуб-ВыручкаСуммРуб<>0,(ВыручкаСуммРуб/(ПродСтоимостьРуб-ВыручкаСуммРуб)*100),"!!!"));
		Таб.ВывестиСекцию("Поставщик");
		Пока Запрос.Группировка(2) = 1 Цикл
			// Заполнение полей ТекущийДокумент
			ТекущийДокумент=Запрос.ТекущийДокумент;
            Если ТекущийДокумент.ПредставлениеВида()="Реализация " тогда
				ТекущийДокумент2=СокрЛП(ТекущийДокумент)+", Пок: "+СокрЛП(ТекущийДокумент.Контрагент);
				Если Запрос.ТекущийДокумент.Скидка<>0 тогда
					СкидкаПоДок=Запрос.ТекущийДокумент.Скидка;
					ТекущийДокумент2=ТекущийДокумент2+"; (Скидка "+СкидкаПоДок+"%).";
				КонецЕсли;
			иначе
				ТекущийДокумент2=ТекущийДокумент;
			КонецЕсли;
			Если ТекущийДокумент.ПредставлениеВида()<>"Перемещение ТМЦ" тогда
				ПродСтоимостьРуб=Запрос.ПродСтоимостьСумма;//-((Запрос.ПродСтоимостьСумма/100)*СкидкаПоДок);
				ПродСтоимостьЕвро=глПересчет(ПродСтоимостьРуб,глРубли,ТекущийДокумент.ДатаДок,глДоллары,ТекущийДокумент.ДатаДок);
				СуммаРубПрих=Запрос.СуммаРубПриход;
				СуммаРубРасх=Запрос.СуммаРубРасход;
				СуммаЕвроПрих=Запрос.СуммаУпрПриход;
				СуммаЕвроРасход=Запрос.СуммаУпрРасход;
				ВыручкаСуммРуб=ПродСтоимостьРуб-СуммаРубРасх;
				Процент=глФРМ(?(ПродСтоимостьРуб-ВыручкаСуммРуб<>0,(ВыручкаСуммРуб/(ПродСтоимостьРуб-ВыручкаСуммРуб)*100),0));
			Иначе
				ПродСтоимостьРуб=0;
				ПродСтоимостьЕвро=0;
				ВыручкаСуммРуб=0;
				ВыручкаСуммРуб=0;
				СуммаРубПрих=0;
				СуммаРубРасх=Запрос.СуммаРубРасход;
				СуммаЕвроПрих=0;
				СуммаЕвроРасход=Запрос.СуммаУпрРасход;
				Процент=0;
			КонецЕсли;
			Состояние("В отчет выводится контрагент:"+сокрЛП(Запрос.ЗначениеУпорядочивания(1))+", документ от: "+СокрЛП(ТекущийДокумент.ДатаДок));
			
			Таб.ВывестиСекцию("ТекущийДокумент");
			Пока (Запрос.Группировка(3) = 1) и (Товар=1) Цикл
				// Заполнение полей Номенклатура
				//Пересчёт их суммы в рубли по курсу того дня
				Если ТекущийДокумент.ПредставлениеВида()<>"Перемещение ТМЦ" тогда
					ПродСтоимостьРуб=Запрос.ПродСтоимостьСумма;//-((Запрос.ПродСтоимостьСумма/100)*СкидкаПоДок);
					ПродСтоимостьЕвро=глПересчет(ПродСтоимостьРуб,глРубли,Запрос.ТекущийДокумент.ДатаДок,глДоллары,Запрос.ТекущийДокумент.ДатаДок);
					СуммаЕвроПрих=Запрос.СуммаУпрПриход;
					СуммаЕвроРасход=Запрос.СуммаУпрРасход;
					СуммаРубПрих=Запрос.СуммаРубПриход;
					СуммаРубРасх=Запрос.СуммаРубРасход;
					ВыручкаСуммРуб=ПродСтоимостьРуб-СуммаРубРасх;
					Процент=глФРМ(?(ПродСтоимостьРуб-ВыручкаСуммРуб<>0,(ВыручкаСуммРуб/(ПродСтоимостьРуб-ВыручкаСуммРуб)*100),0));
				Иначе
					ПродСтоимостьРуб=0;
					ПродСтоимостьЕвро=0;
					ВыручкаСуммРуб=0;
					ВыручкаСуммРуб=0;
					СуммаРубПрих=0;
					СуммаРубРасх=Запрос.СуммаРубРасход;
					СуммаЕвроПрих=0;
					СуммаЕвроРасход=Запрос.СуммаУпрРасход;
					Процент=0;
				КонецЕсли;
				Таб.ВывестиСекцию("Номенклатура");
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	ПродСтоимостьРуб=Запрос.ПродСтоимостьСумма;
	ПродСтоимостьЕвро=глПересчет(ПродСтоимостьРуб,глРубли,ВыбКонПериода,глДоллары,ВыбКонПериода);
	СуммаРубПрих=Запрос.СуммаРубПриход;
	СуммаРубРасх=Запрос.СуммаРубРасход;
	СуммаЕвроПрих=Запрос.СуммаУпрПриход;
	СуммаЕвроРасход=Запрос.СуммаУпрРасход;
	ВыручкаСуммРуб=ПродСтоимостьРуб-СуммаРубРасх;
	Процент=глФРМ(?(ПродСтоимостьРуб-ВыручкаСуммРуб<>0,(ВыручкаСуммРуб/(ПродСтоимостьРуб-ВыручкаСуммРуб)*100),0));
	// Заполнение полей "Итого"
	Таб.ВывестиСекцию("Итого");
	// Вывод заполненной формы
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Сформировать", "");
КонецПроцедуры
	













