Процедура ПриОткрытии()
	ВыбВидДолга	 = Перечисление.ВидыДолга.ДолгЗаТовары;
КонецПроцедуры

//*******************************************
// Процедура генерации запроса Сформировать.
//
Процедура Сформировать()
	Перем Запрос, ТекстЗапроса, Таб;
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(Сформировать)
	|Период с ВыбНачПериода по ВыбКонПериода;
	|Контрагент		= Регистр.Поставщики.Договор.Владелец;
	|Договор 		= Регистр.Поставщики.Договор;
	|КредДокумент 	= Регистр.Поставщики.КредДокумент;
	|ВидДолга		= Регистр.Поставщики.ВидДолга;
	|СуммаРуб		= Регистр.Поставщики.СуммаРуб;
	|ДокументОплаты = Регистр.Поставщики.ДокументОплаты;
	|Функция СуммаРубНачОст = НачОст(СуммаРуб);
	|Функция СуммаРубПриход = Приход(СуммаРуб);
	|Функция СуммаРубРасход = Расход(СуммаРуб);
	|Функция СуммаРубКонОст = КонОст(СуммаРуб);
	|Группировка Контрагент без групп;
	|Группировка Договор без групп;
	|Группировка КредДокумент без групп;
	|Группировка ДокументОплаты без групп;
	|Условие(Договор в ВыбДоговор);
	|Условие(ДокументОплаты в ВыбДокументОплаты);
	|Условие(Контрагент в ВыбКонтрагент);
	|Условие(ВидДолга в ВыбВидДолга);
	|"//}}ЗАПРОС
	;
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;
    
	ТЗ	= СоздатьОбъект("ТаблицаЗначений");
	Запрос.Выгрузить(ТЗ,0,0);
	
	
	ТЗ.Свернуть("Контрагент,Договор,КредДокумент","СуммаРубНачОст,СуммаРубПриход,СуммаРубРасход,СуммаРубКонОст");
	
	ТЗ.НоваяКолонка("ДатаОплаты",		"Дата");

	тз.ВыбратьСтроки();
	Пока тз.ПолучитьСтроку() = 1 Цикл
		если глЕстьРеквизитШапки("ДатаОплаты", тз.КредДокумент.Вид())=1 Тогда
			тз.ДатаОплаты		= тз.КредДокумент.ДатаОплаты;
			если тз.ДатаОплаты = тз.КредДокумент.ДатаДокВходящий Тогда
				тз.ДатаОплаты	= тз.ДатаОплаты + тз.Договор.ГлубинаКредита;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	//Вытащим только то, что нас интересует из всего объёма
	ТЗ1=СоздатьОбъект("ТаблицаЗначений");
	ТЗ1.НоваяКолонка("Контрагент",	"Справочник.Контрагенты");
	ТЗ1.НоваяКолонка("Договор",		"Справочник.Договоры");
	ТЗ1.НоваяКолонка("КредДокумент","Документ");
	ТЗ1.НоваяКолонка("ДатаОплаты",	"Дата");
	ТЗ1.НоваяКолонка("НачОст",		"число", 15,2);
	ТЗ1.НоваяКолонка("Приход",		"число", 15,2);
	ТЗ1.НоваяКолонка("Расход",		"число", 15,2);
	ТЗ1.НоваяКолонка("КонОст",		"число", 15,2);
	
	тз.ВыбратьСтроки();
	Пока тз.ПолучитьСтроку() = 1 Цикл
		Если тз.СуммаРубКонОст<>0 Тогда	//Значит есть какой-то косяк!!!
			если допУсловие=1 Тогда
				если тз.ДатаОплаты<=ВыбКонПериода Тогда
					тз1.НоваяСтрока();
					тз1.Контрагент		= тз.Контрагент;
					тз1.Договор			= тз.Договор;
					тз1.КредДокумент	= тз.КредДокумент;
					тз1.ДатаОплаты		= тз.ДатаОплаты;
					тз1.НачОст 			= тз.СуммаРубНачОст;
					тз1.Приход			= тз.СуммаРубПриход;
					тз1.Расход			= тз.СуммаРубРасход;
					тз1.КонОст			= тз.СуммаРубКонОст;
				КонецЕсли;
			Иначе
				тз1.НоваяСтрока();
				тз1.Контрагент		= тз.Контрагент;
				тз1.Договор			= тз.Договор;
				тз1.КредДокумент	= тз.КредДокумент;
				тз1.ДатаОплаты		= тз.ДатаОплаты;
				тз1.НачОст 			= тз.СуммаРубНачОст;
				тз1.Приход			= тз.СуммаРубПриход;
				тз1.Расход			= тз.СуммаРубРасход;
				тз1.КонОст			= тз.СуммаРубКонОст;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	тз	= "";	//оригинал нам уже не нужен дальше мутим с остатками
//	тз1.ВыбратьСтроку();
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Таблица");
	Таб.ВывестиСекцию("Шапка");
	Таб.Опции(0,0,Таб.ВысотаТаблицы(),0);
  	колвоСтрок	= тз1.КоличествоСтрок();
  	если колвоСтрок>0 Тогда
  		клиент	= тз1.ПолучитьЗначение(1,"Контрагент");
  		тз1.ВыбратьСтроки();
  		суммаЗадолженности			= 0;
  		колво						= 0; 
  		былистроки					= 0;
		СуммаПросроченных			= 0;
		суммаКОплате				= 0;
		суммаКОплатеПросроченных	= 0;
  		
  		Пока тз1.ПолучитьСтроку()=1 Цикл
			колво=колво+1;
			если (тз1.Контрагент<>клиент) и (былистроки=1) Тогда
				Таб.ВывестиСекцию("Итог_клиента");
				суммаЗадолженности = 0;	СуммаПросроченных = 0;
                суммаКОплате = 0; былистроки=0; суммаКОплатеПросроченных = 0;
			Иначе
				суммаЗадолженности	= суммаЗадолженности + тз1.расход;
				суммаКОплате		= суммаКОплате + (-1) * тз1.конОст;
				если тз1.ДатаОплаты<=ВыбКонПериода Тогда
					СуммаПросроченных		= СуммаПросроченных + тз1.расход;
					суммаКОплатеПросроченных= суммаКОплатеПросроченных + (-1) * тз1.конОст;
				КонецЕсли;
				былистроки=1;
				Таб.ВывестиСекцию("Строка");
			КонецЕсли;
			клиент	= тз1.Контрагент;
			если колво=колвоСтрок Тогда
				Таб.ВывестиСекцию("Итог_клиента");
				суммаЗадолженности = 0; СуммаПросроченных = 0; суммаКОплате = 0; суммаКОплатеПросроченных = 0;
			КонецЕсли;
		КонецЦикла;
		
		
	КонецЕсли;
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Просроченные долги","");
КонецПроцедуры  






