//*******************************************
// Процедура генерации запроса Сформировать.
//
Процедура Сформировать()
	Перем Запрос, ТекстЗапроса, Таб;
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(Сформировать)
	|Период с ВыбНачПериода по ВыбКонПериода;
	|Обрабатывать НеПомеченныеНаУдаление;
	|Номенклатура = Регистр.Продажи.Номенклатура;
	|Производитель = Регистр.Продажи.Номенклатура.Производитель;
	|ТекущийДокумент = Регистр.Продажи.ТекущийДокумент;
	|Себестоимость = Регистр.Продажи.Себестоимость;
	|ПродСтоимость = Регистр.Продажи.ПродСтоимость;
	|Количество = Регистр.Продажи.Количество;
	|СебестоимостьВ = Регистр.Продажи.СебестоимостьВ;
	|ПродСтоимостьВ = Регистр.Продажи.ПродСтоимостьВ;
	|КоличествоВ = Регистр.Продажи.КоличествоВ;
	|Проект = Регистр.Продажи.ТекущийДокумент.ВозвратОтПокупателя.Проект, Регистр.Продажи.ТекущийДокумент.Реализация.Проект;
	|Покупатель = Регистр.Продажи.Покупатель;
	|ГруппаКлиента = Регистр.Продажи.Покупатель.Группа;
	|РегионКлиента = Регистр.Продажи.Покупатель.Регион;
	|Поставщик = Регистр.Продажи.Поставщик;
	|Автор = Регистр.Продажи.ТекущийДокумент.ВозвратОтПокупателя.Автор, Регистр.Продажи.ТекущийДокумент.Реализация.Автор;
	|Функция СебестоимостьСумма = Сумма(Себестоимость);
	|Функция ПродСтоимостьСумма = Сумма(ПродСтоимость);
	|Функция КоличествоСумма = Сумма(Количество);
	|Функция СебестоимостьВСумма = Сумма(СебестоимостьВ);
	|Функция ПродСтоимостьВСумма = Сумма(ПродСтоимостьВ);
	|Функция КоличествоВСумма = Сумма(КоличествоВ);
	|Группировка Номенклатура без групп;
	|Группировка ТекущийДокумент без групп;
	|Группировка Покупатель без групп;
	|Группировка Поставщик без групп;
	|Условие(Номенклатура в ВыбНоменклатура);
	|Условие(Производитель в ВыбПроизводитель);
	|Условие(ТекущийДокумент в ВыбТекущийДокумент);
	|Условие(Проект в ВыбПроект);
	|Условие(Покупатель в ВыбПокупатель);
	|Условие(ГруппаКлиента в ВыбГруппаКлиента);
	|Условие(РегионКлиента в ВыбРегионКлиента);
	|Условие(Поставщик в ВыбПоставщик);
	|Условие(Автор в ВыбАвтор);
	|"//}}ЗАПРОС
	;
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;

	ТЗ=СоздатьОбъект("ТаблицаЗначений");
	Запрос.Выгрузить(ТЗ,0,0);
	Состояние("Готовим основную таблицу...");
	ТЗ.ВыбратьСтроки();
	ТЗ.НоваяКолонка("Дата","Дата");
	ТЗ.НоваяКолонка("Валюта","Справочник.Валюты");
	ТЗ.НоваяКолонка("Курс","число",15,5);
	ТЗ.НоваяКолонка("ИтКолво","строка",15);
	ТЗ.НоваяКолонка("ИтСебестРубли","строка",15);
	ТЗ.НоваяКолонка("ИтПродРубли","строка",15);
	ТЗ.НоваяКолонка("ИтСебестДоллары","строка",15);
	ТЗ.НоваяКолонка("ИтПродДоллары","строка",15);
	ТЗ.НоваяКолонка("ИтСебест","строка",15);
	ТЗ.НоваяКолонка("ИтПрод","строка",15);
	ТЗ.НоваяКолонка("Производитель","Справочник.Производители");
	ТЗ.НоваяКолонка("ГруппаТовара","Справочник.Номенклатура");
	ТЗ.НоваяКолонка("Проект","Справочник.Проекты");
	ТЗ.НоваяКолонка("ГруппаКонтрагента","Справочник.Группы");
	ТЗ.НоваяКолонка("Регион","Перечисление.Регион");
	ТЗ.НоваяКолонка("Автор","Справочник.Пользователи");
	
	Состояние("Готовим итоговый отбор...");
	Пока ТЗ.ПолучитьСтроку()=1 Цикл
	    док			= ТЗ.ТекущийДокумент;
		кл			= док.Контрагент;
		ТЗ.Дата		= док.ДатаДок;
		ТЗ.Валюта	= док.Валюта;
		ТЗ.Курс		= док.Курс;
		Если док.Вид()="Реализация" Тогда
			ТЗ.ИтКолво		= стрЗаменить(ТЗ.КоличествоСумма,".",",");
			
			//Это в Евро
			ТЗ.ИтСебест		= стрЗаменить(ТЗ.СебестоимостьСумма,".",",");
			ТЗ.ИтПрод		= стрЗаменить(ТЗ.ПродстоимостьСумма,".",",");
			
			//Это в Рублях
			ТЗ.ИтСебестРубли	= окр(глПересчет(ТЗ.СебестоимостьСумма,глДоллары,ТЗ.Дата,глРубли,ТЗ.Дата),2);
			ТЗ.ИтСебестРубли	= стрЗаменить(ТЗ.ИтСебестРубли,".",",");
			ТЗ.ИтПродРубли		= окр(глПересчет(ТЗ.ПродСтоимостьСумма,глДоллары,ТЗ.Дата,глРубли,ТЗ.Дата),2);
			ТЗ.ИтПродРубли		= стрЗаменить(ТЗ.ИтПродРубли,".",",");
			
			//Это в Долларах
			ТЗ.ИтСебестДоллары	= окр(глПересчет(ТЗ.СебестоимостьСумма,глДоллары,ТЗ.Дата,Доллары,ТЗ.Дата),2);
			ТЗ.ИтСебестДоллары	= стрЗаменить(ТЗ.ИтСебестДоллары,".",",");
			ТЗ.ИтПродДоллары	= окр(глПересчет(ТЗ.ПродСтоимостьСумма,глДоллары,ТЗ.Дата,Доллары,ТЗ.Дата),2);
			ТЗ.ИтПродДоллары	= стрЗаменить(ТЗ.ИтПродДоллары,".",",");
			
		Иначе	//нам надо "с минусом" получить возвраты
			ТЗ.ИтКолво	= стрЗаменить("-"+ТЗ.КоличествоВСумма,".",",");
			
			//Это в Евро
			ТЗ.ИтСебест	= стрЗаменить("-"+ТЗ.СебестоимостьВСумма,".",",");
			ТЗ.ИтПрод	= стрЗаменить("-"+ТЗ.ПродстоимостьВСумма,".",",");
			
			//Это в Рублях
			ТЗ.ИтСебестРубли	= окр(глПересчет(ТЗ.СебестоимостьСумма,глДоллары,ТЗ.Дата,глРубли,ТЗ.Дата),2);
			ТЗ.ИтСебестРубли	= стрЗаменить("-"+ТЗ.ИтСебестРубли,".",",");
			ТЗ.ИтПродРубли		= окр(глПересчет(ТЗ.ПродСтоимостьСумма,глДоллары,ТЗ.Дата,глРубли,ТЗ.Дата),2);
			ТЗ.ИтПродРубли		= стрЗаменить("-"+ТЗ.ИтПродРубли,".",",");

			//Это в Долларах
			ТЗ.ИтСебестДоллары	= окр(глПересчет(ТЗ.СебестоимостьСумма,глДоллары,ТЗ.Дата,Доллары,ТЗ.Дата),2);
			ТЗ.ИтСебестДоллары	= стрЗаменить("-"+ТЗ.ИтСебестДоллары,".",",");
			ТЗ.ИтПродДоллары	= окр(глПересчет(ТЗ.ПродСтоимостьСумма,глДоллары,ТЗ.Дата,Доллары,ТЗ.Дата),2);
			ТЗ.ИтПродДоллары	= стрЗаменить("-"+ТЗ.ИтПродДоллары,".",",");
		КонецЕсли;
		ТЗ.Производитель	= ТЗ.Номенклатура.Производитель;
		ТЗ.ГруппаТовара		= ТЗ.Номенклатура.Родитель;
		ТЗ.Проект			= док.Проект;
		ТЗ.ГруппаКонтрагента= кл.Группа;
		ТЗ.Регион			= кл.Регион;
		ТЗ.Автор			= док.Автор;
	КонецЦикла;

	Состояние("Выводим основную таблицу...");
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Таблица");
	Таб.ВывестиСекцию("Шапка");
	Таб.Опции(0, 0, Таб.ВысотаТаблицы(), 0);
	ТЗ.ВыбратьСтроки();
	Пока ТЗ.получитьСтроку() = 1 Цикл
		Таб.ВывестиСекцию("строка");
	КонецЦикла;
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Сформировать", "");
КонецПроцедуры


