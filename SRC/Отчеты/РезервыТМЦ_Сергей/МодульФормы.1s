//*******************************************
// Процедура генерации запроса Сформировать.
//
Процедура Сформировать()
	Перем Запрос, ТекстЗапроса, Таб;
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(Сформировать)
	|Период с ВыбНачПериода по ВыбКонПериода;
	|Обрабатывать НеПомеченныеНаУдаление;
	|Номенклатура = Регистр.РезервыТМЦ2.Номенклатура;
	|Склад = Регистр.РезервыТМЦ2.Склад;
	|Заявка = Регистр.РезервыТМЦ2.Заявка;
	|Количество = Регистр.РезервыТМЦ2.Количество;
	|ТекущийДокумент = Регистр.РезервыТМЦ2.ТекущийДокумент;
	|Функция КоличествоПриход = Приход(Количество);
	|Функция КоличествоРасход = Расход(Количество);
	|"//}}ЗАПРОС
	;
	
	Если НачОст=1 Тогда
	    ТекстЗапроса=ТекстЗапроса+"Функция КоличествоНачОст = НачОст(Количество);";
	КонецЕсли;
	Если КонОст=1 Тогда
	    ТекстЗапроса=ТекстЗапроса+"Функция КоличествоКонОст = КонОст(Количество);";
	КонецЕсли;

//	Установим порядок группировки в запросе
	стр="";б=0;
	Для а=1 по список.размерСписка() Цикл
		Если список.пометка(а)=1 Тогда
			стр			= список.ПолучитьЗначение(а);
			ТекстЗапроса= ТекстЗапроса+"Группировка "+стр+" без групп;";
			б=б+1;
			Если б=1 Тогда
			    гр1=список.ПолучитьЗначение(а)+"1";
			иначеесли б=2 тогда
			    гр2=список.ПолучитьЗначение(а)+"2";
			иначеесли б=3 тогда
			    гр3=список.ПолучитьЗначение(а)+"3";
			иначеесли б=4 тогда
			    гр1=список.ПолучитьЗначение(а)+"4";
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	ТекстЗапроса	= ТекстЗапроса+"Условие(Номенклатура в ВыбНоменклатура);";
	ТекстЗапроса	= ТекстЗапроса+"Условие(Склад в ВыбСклад);";
	ТекстЗапроса	= ТекстЗапроса+"Условие(Заявка в ВыбЗаявка);";
	
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;

	// Подготовка к заполнению выходных форм данными запроса
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Сформировать");
	// Заполнение полей "Заголовок"
	Таб.ВывестиСекцию("Заголовок");
	Состояние("Заполнение выходной таблицы...");
	Таб.Опции(0, 0, Таб.ВысотаТаблицы(), 0);
	
	Пока (Запрос.Группировка(1) = 1) или (б>=1) Цикл
		состояние("Выводим ТЗ по: "+гр1);
		б=0;
		Таб.ВывестиСекцию(гр1);
		Пока (Запрос.Группировка(2) = 1) или (б>=2) Цикл
			состояние("Выводим ТЗ по: "+гр2);
			б=0;
			Таб.ВывестиСекцию(гр2);
			Пока (Запрос.Группировка(3) = 1) или (б>=3) Цикл
				состояние("Выводим ТЗ по: "+гр3);
				б=0;
				Таб.ВывестиСекцию(гр3);
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	Таб.ВывестиСекцию("Итого");
	// Вывод заполненной формы
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Сформировать", "");
КонецПроцедуры

Процедура ПриОткрытии()
	если Список.РазмерСписка()=0 тогда
		Список.ДобавитьЗначение("Номенклатура");
    	Список.ДобавитьЗначение("Склад");
    	Список.ДобавитьЗначение("Заявка");
    	Список.ДобавитьЗначение("Покупатель");
	иначеесли Список.РазмерСписка()>4 тогда
		Список.удалитьВсе();
		Список.ДобавитьЗначение("Номенклатура");
    	Список.ДобавитьЗначение("Склад");
    	Список.ДобавитьЗначение("Заявка");
    	Список.ДобавитьЗначение("Покупатель");
	КонецЕсли;
КонецПроцедуры

Процедура ИзменениеПорядкаГрупп(реж)	//Сортируем список вниз/вверх
    кол	= Список.РазмерСписка();
	тек	= Список.ТекущаяСтрока();
	Если реж=1 Тогда
		Список.СдвинутьЗначение(реж,тек);
	иначеесли реж=-1 тогда
		Список.СдвинутьЗначение(реж,тек);
	КонецЕсли;
КонецПроцедуры